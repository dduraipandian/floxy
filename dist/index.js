"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class t{constructor({name:n}){if(new.target===t)throw new TypeError("Cannot construct Component instances directly");this.name=n,this.containerID=this.name?this.name.toLowerCase().replace(/\s+/g,"-"):`tab-${Math.random().toString(36).substring(2,15)}`,this.id=this.containerID,this.container=null,this.created=!1,this.rendered=!1,this.parentContainer=null,this.onlyChild=null}renderInto(t,n=!1){let e;if(this.onlyChild=n,this.isRendered())console.warn(`'${this.name}' component is already rendered.`);else{if("string"==typeof t){if(e=document.getElementById(t),!e)throw new Error(`Container with id ${t} not found`)}else{if(!(t instanceof HTMLElement))throw new Error("Container must be a valid HTMLElement or a string ID.");e=t}if(!e.id)throw new Error("Container must have a valid id.");this.parentContainer=e,this.createContainer(),this.onlyChild?this.parentContainer.replaceChildren(this.container):this.parentContainer.appendChild(this.container),console.log("DOM is rendered into container ",e.id),this.rendered=!0}}getParentContainer(){return this.rendered?this.parentContainer:(console.warn(`'${this.name}' component is not rendered yet.`),null)}createContainer(){return this.isCreated()?this.container?this.container:void console.warn(`${this.component} component is already rendered.`):(this.container=this.#t(),this.initContainer(),this.container)}getContainer(){return this.container||this.createContainer(),this.container}#t(){const t=document.createElement("div");t.id=this.containerID,t.style.height="100%",t.style.width="100%";const n=this.html();return t.insertAdjacentHTML("beforeend",n),t}initContainer(){this.init(),this.created=!0}isCreated(){return this.created}isRendered(){return this.rendered}init(){throw new Error("Method 'init()' must be implemented in the subclass")}html(){throw new Error("Method '#html()' must be implemented in the subclass")}}class n extends t{constructor({name:t}){super({name:t}),this.events={}}on(t,n){(this.events[t]||=[]).push(n)}emit(t,n){(this.events[t]||[]).forEach(t=>t(n))}off(t,n){this.events[t]&&(this.events[t]=this.events[t].filter(t=>t!==n))}clear(t){t?delete this.events[t]:this.events={}}}class e extends n{constructor({name:t,options:n={}}){super({name:t}),this.options=n,this.INFO="info",this.SUCCESS="success",this.ERROR="error",this.WARNING="warning",this.#n(this.INFO),this.#n(this.SUCCESS),this.#n(this.ERROR),this.#n(this.WARNING)}#n(t){const n=document.createElement("div");return n.innerHTML=this.html(t),document.body.appendChild(n),n}#e(){return'\n            <div class="modal fade" id="errorNotificationModal" \n                data-bs-backdrop="static" \n                data-bs-keyboard="false" \n                tabindex="-1" \n                aria-labelledby="errorNotificationModalTitle" \n                aria-hidden="true">\n                <div class="modal-dialog modal-dialog-centered">\n                    <div class="modal-content" style="max-width: 650px; width: 650px">\n                        <div class="modal-header">\n                            <h1 class="modal-title fs-5" id="errorNotificationModalTitle"></h1>\n                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>\n                        </div>\n                        <div class="modal-body">\n                            <pre id="errorNotificationModalMessage"></pre>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        '}html(t){let n="bg-info text-dark",e=!0,o="";return"success"===t?n="bg-success text-white":"error"===t?(n="bg-danger text-white",o=this.#e(),e=!1):"warning"===t&&(n="bg-warning text-dark"),`\n            ${o}\n            <div class="uiframe-notification-container position-fixed bottom-0 end-0 p-3 me-2 mb-3">\n                <div id="notification-${t}" \n                    class="toast align-items-center ${n}" \n                    role="alert"\n                    aria-live="assertive"\n                    data-bs-autohide="${e}"\n                    aria-atomic="true" \n                    data-bs-delay="3000">\n                    <div class="d-flex">\n                        <div id="toast-body-${t}" class="toast-body"></div>\n                        <button type="button" \n                            class="btn-close btn-close-white me-2 m-auto" \n                            data-bs-dismiss="toast" \n                            aria-label="Close">\n                        </button>\n                    </div>\n                </div>\n            </div>`}#o(t,n="info"){console.debug("Showing toast message:",t);let e=document.getElementById(`notification-${n}`);document.getElementById(`toast-body-${n}`).innerHTML=t;bootstrap.Toast.getOrCreateInstance(e).show()}#i(t,n){console.error("Showing error modal:",n);const e=document.getElementById("errorNotificationModalTitle"),o=document.getElementById("errorNotificationModalMessage");document.getElementById("toast-body-error").innerHTML+='\n            <span type="button"\n                data-bs-toggle="modal"       \n                data-bs-target="#errorNotificationModal"> \n                    <u>show</u>\n            </span>',e.innerHTML=t,o.innerHTML="string"===n?n:JSON.stringify(n,null,2)}error(t,n,e){console.error("Error toast:",t),this.#o(t,this.ERROR),n&&e&&this.#i(n,e)}success(t){console.debug("Success toast:",t),this.#o(t,this.SUCCESS)}info(t){console.debug("Info toast:",t),this.#o(t,this.INFO)}warning(t){console.debug("Warning toast:",t),this.#o(t,this.WARNING)}}let o=null;class i{constructor(t,n,e={x:0,y:0},o={x:0,y:0},i=1){this.element=t,this.onMoveHandler=n,this.zoomGetter="function"==typeof i?i:()=>i,this.isDragging=!1,this.dragStartPosition=o,this.initialPosition=e,this.elementX=this.initialPosition.x,this.elementY=this.initialPosition.y,this.rafId=null,this.MOUSE_RIGHT_CLICK=2}destroy(){this.element.removeEventListener("mousedown",this.onHold.bind(this)),window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))}registerDragEvent(){this.element.addEventListener("mousedown",this.onHold.bind(this))}onHold(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!0,this.dragStartPosition={x:t.clientX,y:t.clientY},this.initialPosition={x:this.elementX,y:this.elementY},this.element.style.cursor="grabbing",window.addEventListener("mousemove",this.onMove.bind(this)),window.addEventListener("mouseup",this.onRelease.bind(this)),this.startRaf()):console.debug("FLOW: Ignoreing Right click on ",this.element)}onMove(t){if(t.button===this.MOUSE_RIGHT_CLICK)return void console.debug("FLOW: Ignoreing Right click on",this.element);if(t.stopPropagation(),!this.isDragging)return;const n=this.zoomGetter(),e=(t.clientX-this.dragStartPosition.x)/n,o=(t.clientY-this.dragStartPosition.y)/n;this.elementX=this.initialPosition.x+e,this.elementY=this.initialPosition.y+o}onRelease(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!1,this.element.style.cursor="grab",window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))):console.debug("FLOW: Ignoreing right click on",this.element)}static register(t,n,e=1){const o=new i(t,n,{x:0,y:0},{x:0,y:0},e);return o.registerDragEvent(),o}startRaf(){if(this.rafId)return;const t=()=>{if(!this.isDragging)return cancelAnimationFrame(this.rafId),void(this.rafId=null);this.onMoveHandler(this.elementX,this.elementY),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}}class s extends n{constructor({name:t,options:n={}}){super({name:t}),this.options=n,this.zoom=n.zoom||1,this.enableZoomActions=n.enable_zoom_actions||!0,this.originalZoom=this.zoom,this.canvasX=n.canvas?.x||0,this.canvasY=n.canvas?.y||0,this.canvasId=this.id+"-canvas",this.containerId=this.id+"-flow-container",this.zoomActionsId=this.id+"-zoom-actions"}html(){return`\n            <div id="${this.canvasId}" \n                class="flow-canvas" \n                style="transform: translate(${this.canvasX}px, ${this.canvasY}px) scale(${this.zoom})">\n                <svg id="${this.id}-svg" class="flow-connections"></svg>\n            </div>\n            ${this.enableZoomActions?`<div id="${this.zoomActionsId}" class="zoom-actions"></div>`:""}\n        `}init(){this.containerEl=this.parentContainer,this.canvasEl=this.container.querySelector(`#${this.canvasId}`),this.svgEl=this.container.querySelector(`#${this.id}-svg`),this.container=this.canvasEl,i.register(this.containerEl,this.redrawCanvasWithXY.bind(this)),this.enableZoomActions&&this.containerEl.addEventListener("wheel",this.onCanvasWheelZoom.bind(this),{passive:!1}),this.containerEl.addEventListener("dragover",t=>t.preventDefault()),this.containerEl.addEventListener("drop",this.onDrop.bind(this))}redrawCanvas(){this.redrawCanvasWithXY(this.canvasX,this.canvasY)}redrawCanvasWithXY(t,n){this.canvasX=t,this.canvasY=n,this.canvasEl.style.transform=`translate(${t}px, ${n}px) scale(${this.zoom})`;const e=this.gridFactor*this.zoom;this.containerEl.style.backgroundSize=`${e}px ${e}px`,this.containerEl.style.backgroundPosition=`${t}px ${n}px`,this.containerEl.style.backgroundImage=`radial-gradient(#c1c1c4 ${1.5*this.zoom}px, transparent ${1.5*this.zoom}px)`}onCanvasWheelZoom(t){t.preventDefault(),console.log("FLOW: Wheel on canvas with deltaY: ",t.deltaY);const n=t.deltaY>0?-.1:.1,e=Math.max(.1,Math.min(this.zoom+n,3));this.zoom=e,this.redrawCanvas(),this.emit("canvas:zoom",{data:{zoom:this.zoom,x:this.canvasX,y:this.canvasY,delta:n,originalZoom:this.originalZoom}})}onDrop(t){t.preventDefault(),t.stopPropagation();try{const n=t.dataTransfer.getData("application/json");if(!n)return;const e=JSON.parse(n),o=this.containerEl.getBoundingClientRect(),i=t.clientX-o.left-this.canvasX,s=t.clientY-o.top-this.canvasY;this.emit("node:dropped",{data:{x:i,y:s,...e}}),console.debug("FLOW - DROP: ",e,i,s)}catch(t){console.error("Invalid drop data",t)}}}const a="node:moved",d="node:removed",r="connection:created",c="connection:removed",h="connection:clicked";class l extends n{constructor({name:t,canvasContainer:n,options:e={}}){super({name:t+"-flow-node-manager"}),this.options=e,this.zoom=e.zoom||1,this.originalZoom=this.zoom,this.nodes={},this.nodeIdCounter=1,this.nodeWidth=e.nodeWidth||200,this.nodeHeight=e.nodeHeight||90,this.selectedNodeId=null,this.canvasContainer=n}dropNode(t){const n=(t.x-this.nodeWidth/2)/this.zoom,e=(t.y-this.nodeHeight/2)/this.zoom;this.addNode({...t,x:n,y:e})}addNode({name:t,inputs:n=1,outputs:e=1,x:o=0,y:i=0,html:s=""}){const a=this.nodeIdCounter++,d={id:a,name:t,inputs:n,outputs:e,x:o,y:i,contentHtml:s};return this.nodes[a]=d,this.renderNode(d),a}renderNode(t){const n=document.createElement("div"),e=`<div class="flow-port" data-type="input" data-node-id="${t.id}" data-index="{{index}}"></div>`,o=`<div class="flow-port" data-type="output" data-node-id="${t.id}" data-index="{{index}}"></div>`,s=`\n        <div id="node-${t.id}" \n            data-id="${t.id}" \n            class="flow-node rounded" \n            style="top: ${t.y}px; left: ${t.x}px; \n                    width: ${this.nodeWidth}px; height: fit-content">                        \n            <div class="flow-ports-column flow-ports-in">\n                ${Array.from({length:t.inputs},(t,n)=>e.replace("{{index}}",n)).join("\n")}\n            </div>\n            <div class="flow-node-content card w-100">              \n              <div class="card-header">${t.name}</div>\n              <div class="card-body">${t.contentHtml}</div>              \n            </div>            \n            <div class="flow-ports-column flow-ports-out">                \n                ${Array.from({length:t.outputs},(t,n)=>o.replace("{{index}}",n)).join("\n")}\n            </div>\n            <button type="button" \n                data-id="${t.id}"\n                class="btn-danger btn-close node-close border rounded shadow-none m-1" \n                aria-label="Close">\n            </button>\n        </div>\n        `;n.innerHTML=s;const a=n.querySelector(`#node-${t.id}`);a.onclick=n=>this.onNodeClick(n,t.id),a.onmousedown=n=>this.onNodeClick(n,t.id);new i(a,this.redrawNodeWithXY.bind(this,t.id),{x:this.nodes[t.id].x,y:this.nodes[t.id].y},{x:0,y:0},()=>this.zoom).registerDragEvent(),a.querySelector("button.node-close").addEventListener("click",n=>this.removeNode(n,t.id)),a.querySelectorAll(".flow-ports-out .flow-port").forEach(n=>{n.onmousedown=e=>{this.emit("port:connect:start",{nodeId:t.id,portIndex:n.dataset.index,event:e})}}),a.querySelectorAll(".flow-ports-in .flow-port").forEach(n=>{n.onmouseup=e=>{this.emit("port:connect:end",{nodeId:t.id,portIndex:n.dataset.index,event:e})}}),this.nodes[t.id].el=a,this.canvasContainer.appendChild(a)}reset(){Object.values(this.nodes).forEach(t=>{t.el?.remove()}),this.nodes={},this.nodeIdCounter=1,this.selectedNodeId=null}redrawNodeWithXY(t,n,e){this.nodes[t].x=n,this.nodes[t].y=e,this.nodes[t].el.style.top=`${e}px`,this.nodes[t].el.style.left=`${n}px`,this.emit(a,{id:t,x:n,y:e})}onNodeClick(t,n){this.selectedNodeId&&this.nodes[this.selectedNodeId]&&this.nodes[this.selectedNodeId].el.classList.remove("selected"),this.nodes[n].el.classList.add("selected"),this.selectedNodeId=n}removeNode(t,n){console.debug("FLOW: removing node ",n),t.stopPropagation();const e=parseInt(n);this.emit(d,{id:e}),this.nodes[n].el.remove(),delete this.nodes[n]}}class m extends n{constructor({name:t,connectionContainer:n,nodeManager:e,options:o={}}){super({name:t+"-flow-connection-manager",options:o}),this.connectionContainer=n,this.nodeManager=e,this.options=o,this.zoom=o.zoom||1,this.originalZoom=this.zoom,this.nodes=this.nodeManager.nodes,this.nodeIdCounter=1,this.nodeWidth=o.nodeWidth||200,this.nodeHeight=o.nodeHeight||90,this.connections=[],this.pathMap=new Map,this.tempPath=null,this.badPaths=new Set,this.tempSource=null}addConnection(t,n,e,o){const i=parseInt(t),s=parseInt(e),a=parseInt(n),d=parseInt(o);if(this.connections.some(t=>t.outNodeId===i&&t.outPort===a&&t.inNodeId===s&&t.inPort===d))return;const c={outNodeId:i,outPort:a,inNodeId:s,inPort:d};return this.connections.push(c),this.createConnectionPath(c),this.emit(r,c),!0}reset(){this.connections=[],this.pathMap.forEach(t=>t.remove()),this.pathMap.clear(),this.clearTempPath?.()}getConnectionKey(t){return`${t.outNodeId}:${t.outPort}-${t.inNodeId}:${t.inPort}`}createConnectionPath(t){const n=this.getConnectionKey(t),e=this.getPortPosition(t.outNodeId,"output",t.outPort),o=this.getPortPosition(t.inNodeId,"input",t.inPort),i=document.createElementNS("http://www.w3.org/2000/svg","path"),s=this.getBazierPath(e.x,e.y,o.x,o.y);i.setAttribute("d",s),i.setAttribute("class","flow-connection-path"),i.dataset.id=n,i.onclick=n=>{n.stopPropagation(),this.emit(h,t)},this.connectionContainer.appendChild(i),this.pathMap.set(n,i)}updateConnections(t){const n=parseInt(t);this.connections.filter(t=>t.outNodeId===n||t.inNodeId===n).forEach(t=>{const n=this.getConnectionKey(t),e=this.pathMap.get(n);if(!e)return;const o=this.getPortPosition(t.outNodeId,"output",t.outPort),i=this.getPortPosition(t.inNodeId,"input",t.inPort),s=this.getBazierPath(o.x,o.y,i.x,i.y);e.setAttribute("d",s),this.emit("connection:updated",t)})}removeConnection(t){const n=this.getConnectionKey(t),e=this.pathMap.get(n);e&&(e.remove(),this.pathMap.delete(n)),this.connections=this.connections.filter(n=>n!==t),this.emit(c,t)}removeRelatedConnections(t){this.connections.filter(n=>n.outNodeId===t||n.inNodeId===t).forEach(t=>{this.removeConnection(t)})}getPortPosition(t,n,e){const o=this.nodes[t];if(!o||!o.el)return{x:0,y:0};const i=o.el.querySelector(`.flow-port[data-type="${n}"][data-index="${e}"]`);if(!i)return{x:o.x,y:o.y};const s=i.getBoundingClientRect(),a=o.el.getBoundingClientRect(),d=(s.left-a.left+s.width/2)/this.zoom,r=(s.top-a.top+s.height/2)/this.zoom;return{x:o.x+d,y:o.y+r}}getBazierPath(t,n,e,o){return`M ${t} ${n} C ${t+.5*Math.abs(e-t)} ${n} ${e-.5*Math.abs(e-t)} ${o} ${e} ${o}`}beginTempConnection(t,n){this.tempSource={nodeId:t,portIndex:n}}endTempConnection(){this.tempSource=null,this.clearTempPath()}updateTempConnection(t,n){if(!this.tempSource)return;const{nodeId:e,portIndex:o}=this.tempSource,i=this.getPortPosition(e,"output",o);this.createTempPath(i,{x:t,y:n})}createTempPath(t,n){if(this.tempPath)this.clearBadPaths();else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("class","flow-connection-path selected flow-connection-temp"),t.style.pointerEvents="none",this.connectionContainer.appendChild(t),this.tempPath=t}const e=this.getBazierPath(t.x,t.y,n.x,n.y);this.tempPath.setAttribute("d",e)}clearTempPath(){this.tempPath&&(this.tempPath.remove(),this.tempPath=null),this.clearBadPaths()}markPathBad(t){this.markTempPathBad(),this.markExistingPathBad(t)}markTempPathBad(){this.tempPath&&(this.tempPath.classList.add("flow-connection-path-bad"),this.badPaths.add(this.tempPath))}markExistingPathBad(t){const n=this.getConnectionKey(t),e=this.pathMap.get(n);e&&(e.classList.add("flow-connection-path-bad"),this.badPaths.add(e))}clearBadPaths(){this.badPaths.forEach(t=>{t.classList.remove("flow-connection-path-bad")}),this.badPaths.clear()}}class u{export(t){const n=t.nodeManager,e=t.connectionManager,o=t.canvas;return{nodes:Object.values(n.nodes).map(({el:t,node:n,...e})=>({id:e.id,name:e.name,inputs:e.inputs,outputs:e.outputs,x:e.x,y:e.y,html:e.html})),connections:e.connections.map(t=>({outNodeId:t.outNodeId,outPort:t.outPort,inNodeId:t.inNodeId,inPort:t.inPort})),zoom:o.zoom,canvas:{x:o.canvasX,y:o.canvasY}}}import(t,n){const{nodeManager:e,connectionManager:o,canvas:i}=t,s=n.zoom||1;t.zoom=s,i.zoom=s,e.zoom=s,o.zoom=s,i.canvasX=n.canvas?.x||0,i.canvasY=n.canvas?.y||0,i.redrawCanvas(),e.reset?.(),o.reset?.(),n.nodes&&n.nodes.forEach(t=>{e.addNode(t)}),n.connections&&n.connections.forEach(n=>{t.addConnection(n.outNodeId,n.outPort,n.inNodeId,n.inPort)})}}class p{onConnectionAttempt({outNodeId:t,inNodeId:n}){return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:n}){}onConnectionRemoved({outNodeId:t,inNodeId:n}){}}exports.DagValidator=class extends p{constructor({enabled:t=!0}={}){super(),this.enabled=t,this.adjacencyList={},this.nonCyclicCache={},this.tempCyclicCache={},this.tempStackCache={}}onConnectionAttempt({outNodeId:t,inNodeId:n}){const e="This connection will create cyclic flow.";if(!this.enabled)return{valid:!0};const o=`${t}->${n}`;if(void 0!==this.nonCyclicCache[o])return{valid:!this.nonCyclicCache[o]};if(this.tempCyclicCache[o])return{valid:!1,stack:this.tempStackCache[o],message:e};this.tempStackCache[o]=[];const i=this.tempStackCache[o],s=new Set;let a=new Set(this.adjacencyList[t]||new Set);a.add(n),s.add(t),i.push(t);for(const t of a)if(this.#s(t,s,i))return this.tempCyclicCache[o]=!0,{valid:!1,stack:i,message:e};return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:n}){this.#a(t,n),this.#d(t,n)}onConnectionRemoved({outNodeId:t,inNodeId:n}){const e=`${t}->${n}`;this.adjacencyList[t]?.delete(n),delete this.nonCyclicCache[e],this.tempCyclicCache={}}#a(t,n){this.adjacencyList[t]||(this.adjacencyList[t]=new Set),this.adjacencyList[t].add(n)}#d(t,n){const e=`${t}->${n}`;this.nonCyclicCache[e]=!1,delete this.tempStackCache[e]}#s(t,n,e){if(e.includes(t))return e.push(t),!0;if(n.has(t))return!1;n.add(t),e.push(t);for(const o of this.adjacencyList[t]||[])if(this.#s(o,n,e))return!0;return e.pop(),!1}},exports.Flow=class extends n{constructor({name:t,options:n={},validators:e=[],notification:o=null}){super({name:t}),this.options=n,this.validators=e,this.notification=o,this.serializer=new u,this.zoom=n.zoom||1,this.originalZoom=this.zoom,this.nodes={},this.nodeIdCounter=1,this.canvasEl=null,this.svgEl=null,this.nodeManager=null,this.connectionManager=null,this.rafId=null,this.isConnecting=!1}html(){return""}init(){this.container.classList.add("floxy-flow-container"),this.canvas=new s({name:this.name+"-canvas",options:this.options}),this.canvas.renderInto(this.container),this.containerEl=this.container,this.canvasEl=this.canvas.canvasEl,this.svgEl=this.canvas.svgEl,this.nodeManager=new l({name:this.name+"-flow-node-manager",canvasContainer:this.canvasEl,options:this.options}),this.connectionManager=new m({name:this.name+"-flow-connection-manager",connectionContainer:this.svgEl,nodeManager:this.nodeManager,options:this.options}),this.canvas.on("canvas:zoom",({data:t})=>{this.zoom=t.zoom,this.connectionManager.zoom=t.zoom,this.nodeManager.zoom=t.zoom}),this.canvas.on("node:dropped",({data:t})=>{console.debug("Node is dropped: ",t),this.emit("node:dropped",t),this.nodeManager.dropNode(t)}),this.nodeManager.on(a,({id:t,x:n,y:e})=>{console.debug("Node is moved: ",t,n,e),this.emit(a,{id:t,x:n,y:e}),this.connectionManager.updateConnections(t)}),this.nodeManager.on(d,({id:t})=>{console.debug("Node is removed: ",t),this.emit(d,{id:t}),this.removeNode(t)}),this.nodeManager.on("port:connect:start",({nodeId:t,portIndex:n,event:e})=>{this.mouseDownStartConnection({dataset:{index:n}},t,e)}),this.nodeManager.on("port:connect:end",({nodeId:t,portIndex:n,event:e})=>{this.mouseUpCompleteConnection({dataset:{index:n}},t,e)}),this.connectionManager.on(r,t=>{console.debug("Connection is created: ",t),this.emit(r,t),this.validators.forEach(n=>n.onConnectionAdded?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))}),this.connectionManager.on(h,t=>{console.debug("Connection is clicked: ",t),this.emit(h,t),this.connectionManager.removeConnection(t)}),this.connectionManager.on(c,t=>{console.debug("Connection is removed: ",t),this.emit(c,t),this.validators.forEach(n=>n.onConnectionRemoved?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))})}highlightCycle(t){if(t&&!(t.length<2))for(let n=0;n<t.length-1;n++){const e=this.connectionManager.connections.find(e=>e.outNodeId===t[n]&&e.inNodeId===t[n+1]);e&&this.connectionManager.markPathBad(e)}}addNode(t){return this.nodeManager.addNode(t)}mouseDownStartConnection(t,n,e){console.debug("FLOW: Start connection from port: ",t,"nodeId: ",n),e.stopPropagation(),this.isConnecting=!0,this.connectionStart={nodeId:n,index:t.dataset.index},this.connectionManager.beginTempConnection(n,t.dataset.index),this._drawConnection=e=>this.mouseMoveDrawConnection(t,n,e),this._cancelConnection=t=>this.keyDownCancelConnection(t,n),window.addEventListener("mousemove",this._drawConnection),window.addEventListener("keydown",this._cancelConnection),this.startRaf(()=>{const t=this.connectionStart.prevX==this.connectionStart.x&&this.connectionStart.prevY==this.connectionStart.y;this.connectionStart.x&&this.connectionStart.y&&!t&&(this.connectionStart.prevX=this.connectionStart.x,this.connectionStart.prevY=this.connectionStart.y,this.connectionManager.updateTempConnection(this.connectionStart.x,this.connectionStart.y))})}mouseMoveDrawConnection(t,n,e){if(this.isConnecting){this._canvasRect||(this._canvasRect=this.canvasEl.getBoundingClientRect());const t=this._canvasRect,n=(e.clientX-t.left)/this.zoom,o=(e.clientY-t.top)/this.zoom;this.connectionStart.x=n,this.connectionStart.y=o}}mouseUpCompleteConnection(t,n,e){if(this.isConnecting){const t=e.target.closest(".flow-port");if(t&&"input"===t.dataset.type){const o=parseInt(t.dataset.nodeId),i=parseInt(t.dataset.index);this.addConnection(this.connectionStart.nodeId,this.connectionStart.index,o,i,e,n)&&this.connectionManager.endTempConnection()}}}addConnection(t,n,e,o,i=null,s=null){for(const n of this.validators){const o=n.onConnectionAttempt({outNodeId:t,inNodeId:e});if(!o.valid)return this.notification?.warning(o.message),this.connectionManager.markTempPathBad(),o.stack&&this.highlightCycle(o.stack),!1}const a=this.connectionManager.addConnection(t,n,e,o);return a&&(this.validators.forEach(n=>n.onConnectionAdded?.({outNodeId:t,inNodeId:e})),i&&this.keyDownCancelConnection(i,s)),a}keyDownCancelConnection(t,n){"keydown"==t.type&&"Escape"!==t.key&&27!==t.keyCode||(this.isConnecting=!1,this.connectionManager.endTempConnection(),this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection),this._drawConnection=null))}removeNode(t){this.connectionManager.removeRelatedConnections(t)}export(){return this.serializer.export(this)}import(t){this.serializer.import(this,t)}startRaf(t){if(this.rafId)return;const n=()=>{if(!this.isConnecting)return cancelAnimationFrame(this.rafId),this.rafId=null,void(this._canvasRect=null);t(),this.rafId=requestAnimationFrame(n)};this.rafId=requestAnimationFrame(n)}destroy(){this.isConnecting=!1,this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection)),cancelAnimationFrame(this.rafId)}},exports.FlowCanvas=s,exports.notification=function({app:t,options:n={}}){return"undefined"!=typeof window&&window.uiframe?(window.uiframe._notification=window.uiframe._notification||new e({name:t,options:n}),window.uiframe._notification):(o||(o=new e({name:t,options:n})),o)};
