var floxy=function(t){"use strict";class e{constructor({options:t={}}){this.options=t}static get capability(){throw new Error("Static property capability must be implemented in the subclass")}isSupported(t){const e=t.isCapabilitySupported(this.constructor.capability);return console.debug("FLOW: Is behavior supported",this.constructor.capability,e),e}}class o extends e{constructor({component:t,options:e={}}){super(e),this.component=t,this.manager=e.manager,this.attached=!1}static get removal_event(){throw new Error("Static property removal_event must be implemented in the subclass")}_attach(){this.isSupported(this.component)&&this.gaurd()&&(this.attach(),this.attached=!0,this.component.on(this.constructor.removal_event,this.destroy))}gaurd(){return!0}attach(){throw new Error("Method 'attach()' must be implemented in the subclass")}detach(){throw new Error("Method 'detach()' must be implemented in the subclass")}destroy(){this.detach(),this.component.off(this.constructor.removal_event,this.destroy)}}const n="canvas:zoom",i="node:removed",s="node:moved",a="node:selected",r="node:deselected",l="node:dropped",h="node:updated",c="node:label:updated",d="node:port:connect:start",m="node:port:connect:end",u="connection:created",p="connection:removed",g="connection:selected",y="connection:deselected",v="bezier",w=v,b="line",f="orthogonal",x={BEZIER:`path:${w}`,LINE:`path:${b}`,ORTHOGONAL:`path:${f}`},C="selectable",E={MOVABLE:"movable",EDITABLE_LABEL:"editable-label",RESIZABLE:"resizable",REMOVABLE:"removable"},L=[C,E.MOVABLE,E.EDITABLE_LABEL,E.RESIZABLE,E.REMOVABLE],I=[C,E.REMOVABLE,x.BEZIER,x.LINE,x.ORTHOGONAL],k=["ellipse","circle","rect","line","polyline","polygon","path"],z={Delete:E.REMOVABLE,Backspace:E.REMOVABLE};let S=null;function M(t){S=t}function $(){return S}class P extends o{constructor({component:t,options:e={}}){super({component:t,options:e}),this.selected=!1}static get capability(){return C}attach(){const t=this.component.view;this._onPointerDown=(t=>{t.stopPropagation(),this.select(t.clientX,t.clientY)}).bind(this),t.attachEvent("click",this._onPointerDown)}select(t,e){$()!==this&&($()?.deselect(),this.selected=!0,this.component.select(t,e),M(this))}deselect(){this.component.destroyed||this.component.deselect(),M(null),this.selected=!1}detach(){this._onPointerDown&&this.component?.view?.el&&this.component.view.detachEvent("click",this._onPointerDown)}static get select_event(){throw new Error("Static property select_event must be implemented in the subclass")}static get deselect_event(){throw new Error("Static property deselect_event must be implemented in the subclass")}}class A{constructor(t,e,o={x:0,y:0},n={x:0,y:0},i=1,s="grabbing",a="grab"){this.element=t,this.onMoveHandler=e,this.zoomGetter="function"==typeof i?i:()=>i,this.isDragging=!1,this.dragStartPosition=n,this.initialPosition=o,this.elementX=this.initialPosition.x,this.elementY=this.initialPosition.y,this.cx=this.initialPosition.x,this.cy=this.initialPosition.y,this.rafId=null,this.onMoveCursor=s,this.onReleaseCursor=a,this.MOUSE_RIGHT_CLICK=2}destroy(){this.element.removeEventListener("mousedown",this.onHold.bind(this)),window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))}registerDragEvent(){this.element.addEventListener("mousedown",this.onHold.bind(this))}onHold(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!0,this.dragStartPosition={x:t.clientX,y:t.clientY},this.initialPosition={x:this.elementX,y:this.elementY},this.element.style.cursor=this.onMoveCursor,window.addEventListener("mousemove",this.onMove.bind(this)),window.addEventListener("mouseup",this.onRelease.bind(this)),this.startRaf()):console.debug("FLOW: Ignoreing Right click on ",this.element)}onMove(t){if(t.button===this.MOUSE_RIGHT_CLICK)return void console.debug("FLOW: Ignoreing Right click on",this.element);if(t.stopPropagation(),!this.isDragging)return;const e=this.zoomGetter(),o=(t.clientX-this.dragStartPosition.x)/e,n=(t.clientY-this.dragStartPosition.y)/e;this.elementX=this.initialPosition.x+o,this.elementY=this.initialPosition.y+n}onRelease(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!1,this.element.style.cursor=this.onReleaseCursor,window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))):console.debug("FLOW: Ignoreing right click on",this.element)}static register(t,e,o=1){const n=new A(t,e,{x:0,y:0},{x:0,y:0},o);return n.registerDragEvent(),n}startRaf(){if(this.rafId)return;const t=()=>{if(!this.isDragging)return cancelAnimationFrame(this.rafId),void(this.rafId=null);this.rafId=requestAnimationFrame(t),this.cx==this.elementX&&this.cy==this.elementY||(this.onMoveHandler(this.elementX,this.elementY),this.cx=this.elementX,this.cy=this.elementY)};this.rafId=requestAnimationFrame(t)}}class N{constructor(){this._registry=new Map}register(t){const e=t.capability;if(!e)throw new Error(`Capability ${t.name} must define static capability`);this._registry.set(e,t)}get(t){return this._registry.get(t)}getAll(){return Array.from(this._registry.values()||[])}resolve(t,e={}){const o=new Set;return t.model.capabilities?.forEach(t=>{const n=this.get(t);if(n){const t=new n(e);o.add(t)}}),o}}class T extends o{constructor({component:t,options:e={}}){super({component:t,options:e}),this.node=this.component}static get removal_event(){return i}}const _=new N,R=new N;class B extends e{static get group(){return"default"}static get capability(){throw new Error("Static property capability must be implemented in the subclass")}get clearSelection(){return!1}canExecute(t){return this.isSupported(t)}run(t,e,o){return this.canExecute(o)?this.execute(t,e,o):(t.notification?.error(`${this.constructor.capability} is not supported`),!1)}execute(t,e,o){throw new Error("Method 'execute()' must be implemented in the subclass")}static get label(){return this.capability}static get order(){return 0}static get icon(){return""}static get toolclass(){return""}}class D extends B{static get group(){return"danger"}static get capability(){return"removable"}get clearSelection(){return!0}execute(t,e,o){return e.remove(o.id),!0}static get label(){return"Delete"}static get order(){return 100}static get icon(){return'<i class="bi bi-trash text-danger"></i>'}}class O extends B{static get capability(){return x.BEZIER}static get group(){return"path"}static get order(){return 10}static get icon(){return"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M 4 8 C 12 0, 16 24, 20 10' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>"}execute(t,e,o){return o.setPathStyle(w),!0}}class H extends B{static get capability(){return x.LINE}static get group(){return"path"}static get order(){return 20}static get icon(){return"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M2 12H22' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>"}execute(t,e,o){return o.setPathStyle(b),!0}}class W extends B{static get capability(){return x.ORTHOGONAL}static get group(){return"path"}static get order(){return 30}static get icon(){return"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M0 2 H10 V20 H20' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>"}execute(t,e,o){return o.setPathStyle(f),!0}}const F=new N,Z=new N;let j=new class{constructor(){this.paths=new Map}register(t,e){this.paths.set(t,e)}get(t){return this.paths.get(t)}has(t){return this.paths.has(t)}getAll(){return[...this.paths.keys()]}};j.register("line",({p1:t,p2:e,options:o={}})=>`M ${t.x} ${t.y} L ${e.x} ${e.y}`),j.register("bezier",({p1:t,p2:e,options:o={}})=>{const n=o.curvature??.7,i=t.x+Math.abs(e.x-t.x)*n,s=e.x-Math.abs(e.x-t.x)*n;return`M ${t.x} ${t.y}\n            C ${i} ${t.y} ${s} ${e.y} ${e.x} ${e.y}`}),j.register("orthogonal",({p1:t,p2:e,sourceBounds:o,targetBounds:n,sourceDir:i="right",targetDir:s="left",options:a={}})=>{const r=n?.height||50,l="vertical"===a.direction,h=a.clearance??60,c=t.x+h,d=t.y+h,m=l?e.y>d+40:e.y+1>t.y,u=l?e.x+1>t.x:e.x>c+40,p=[`M ${t.x} ${t.y}`];p.push(`L ${c} ${t.y}`);let g=Math.abs(e.y-t.y),y=Math.abs(t.x-e.x);if(m)if(u)p.push(`v ${g}`),p.push("h "+(y-h));else{let t=.9*(g-r),o=g-t,n=Math.abs(c+40-e.x);p.push(`v ${t}`),p.push("h "+-1*n),p.push(`v ${o}`),p.push(`L ${e.x} ${e.y}`)}else if(u)p.push("v "+-1*g),p.push("h "+(y-h));else{let t=.9*(g-r),o=g-t,n=Math.abs(c+40-e.x);p.push("v "+-1*t),p.push("h "+-1*n),p.push("v "+-1*o),p.push(`L ${e.x} ${e.y}`)}return p.join(" ")});class q{constructor({name:t}){if(new.target===q)throw new TypeError("Cannot construct Component instances directly");this.name=t,this.containerID=this.name?this.name.toLowerCase().replace(/\s+/g,"-"):`tab-${Math.random().toString(36).substring(2,15)}`,this.id=this.containerID,this.container=null,this.created=!1,this.rendered=!1,this.parentContainer=null,this.onlyChild=null}renderInto(t,e=!1){let o;if(this.onlyChild=e,this.isRendered())console.warn(`'${this.name}' component is already rendered.`);else{if("string"==typeof t){if(o=document.getElementById(t),!o)throw new Error(`Container with id ${t} not found`)}else{if(!(t instanceof HTMLElement))throw new Error("Container must be a valid HTMLElement or a string ID.");o=t}if(!o.id)throw new Error("Container must have a valid id.");this.parentContainer=o,this.createContainer(),this.onlyChild?this.parentContainer.replaceChildren(this.container):this.parentContainer.appendChild(this.container),console.log("DOM is rendered into container ",o.id),this.rendered=!0}}getParentContainer(){return this.rendered?this.parentContainer:(console.warn(`'${this.name}' component is not rendered yet.`),null)}createContainer(){return this.isCreated()?this.container?this.container:void console.warn(`${this.component} component is already rendered.`):(this.container=this.#t(),this.initContainer(),this.container)}getContainer(){return this.container||this.createContainer(),this.container}#t(){const t=document.createElement("div");t.id=this.containerID,t.style.height="100%",t.style.width="100%";const e=this.html();return t.insertAdjacentHTML("beforeend",e),t}initContainer(){this.init(),this.created=!0}isCreated(){return this.created}isRendered(){return this.rendered}init(){throw new Error("Method 'init()' must be implemented in the subclass")}html(){throw new Error("Method '#html()' must be implemented in the subclass")}}class G extends q{constructor({name:t}){super({name:t}),this.events={}}on(t,e){(this.events[t]||=[]).push(e)}emit(t,e){(this.events[t]||[]).forEach(t=>t(e))}off(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(t=>t!==e))}clear(t){t?delete this.events[t]:this.events={}}}class Y extends G{constructor({name:t,options:e={}}){super({name:t}),this.options=e,this.zoom=e.zoom||1,this.enableZoomActions=e.enable_zoom_actions||!0,this.originalZoom=this.zoom,this.canvasX=e.canvas?.x||0,this.canvasY=e.canvas?.y||0,this.canvasId=this.id+"-canvas",this.containerId=this.id+"-flow-container",this.zoomActionsId=this.id+"-zoom-actions",this.arrowMarkerSize=e.arrow_marker_size||7,this.zoomRafId=null,this.targetZoom=this.zoom,this.zoomEase=e.zoom_ease||.15,this.minZoom=.1,this.maxZoom=3}html(){return`\n            <div id="${this.canvasId}" \n                class="flow-canvas" \n                style="transform: translate(${this.canvasX}px, ${this.canvasY}px) scale(${this.zoom})">\n                <svg id="${this.id}-svg" class="flow-connections"></svg>\n            </div>\n            ${this.enableZoomActions?`<div id="${this.zoomActionsId}" class="zoom-actions"></div>`:""}\n        `}init(){this.containerEl=this.parentContainer,this.canvasEl=this.container.querySelector(`#${this.canvasId}`),this.svgEl=this.container.querySelector(`#${this.id}-svg`),this.container=this.canvasEl,A.register(this.containerEl,this.redrawCanvasWithXY.bind(this)),this.enableZoomActions&&this.containerEl.addEventListener("wheel",this.onCanvasWheelZoom.bind(this),{passive:!1}),this.containerEl.addEventListener("dragover",t=>t.preventDefault()),this.containerEl.addEventListener("drop",this.onDrop.bind(this)),function(t,e=5){if(t.querySelector("#arrow-end"))return;const o=document.createElementNS("http://www.w3.org/2000/svg","defs"),n=(t,o)=>{const n=document.createElementNS("http://www.w3.org/2000/svg","marker");n.setAttribute("id",t),n.setAttribute("markerWidth",e),n.setAttribute("markerHeight",e),n.setAttribute("refX",e),n.setAttribute("refY",e/2),n.setAttribute("orient","auto");const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",o),i.setAttribute("fill","context-stroke"),n.appendChild(i),n};o.appendChild(n("arrow-end",`M 0 0 L ${e} ${e/2} L 0 ${e} Z`)),o.appendChild(n("arrow-start",`M ${e} 0 L 0 ${e/2} L ${e} ${e} Z`)),t.appendChild(o)}(this.svgEl,this.arrowMarkerSize)}redrawCanvas(){this.redrawCanvasWithXY(this.canvasX,this.canvasY)}redrawCanvasWithXY(t,e){this.canvasX=t,this.canvasY=e,this.canvasEl.style.transform=`translate(${t}px, ${e}px) scale(${this.zoom})`;const o=this.gridFactor*this.zoom;this.containerEl.style.backgroundSize=`${o}px ${o}px`,this.containerEl.style.backgroundPosition=`${t}px ${e}px`}onCanvasWheelZoom(t){t.preventDefault(),console.debug("FLOW: Wheel on canvas with deltaY: ",t.deltaY);const e=t.deltaY>0?-.1:.1;this.targetZoom=Math.max(this.minZoom,Math.min(this.zoom+e,this.maxZoom)),this.zoomRaf()}handleZoomChange(t){this.zoom=t,this.redrawCanvas(),this.emitZoomEvent()}emitZoomEvent(){this.emit(n,{data:{zoom:this.zoom,x:this.canvasX,y:this.canvasY,originalZoom:this.originalZoom}})}zoomRaf(){if(this.zoomRafId)return;const t=()=>{const e=this.targetZoom-this.zoom;if(Math.abs(e)<.001)return cancelAnimationFrame(this.zoomRafId),void(this.zoomRafId=null);const o=this.zoom+e*this.zoomEase;this.handleZoomChange(o),this.zoomRafId=requestAnimationFrame(t)};this.zoomRafId=requestAnimationFrame(t)}onDrop(t){t.preventDefault(),t.stopPropagation();try{const e=t.dataTransfer.getData("module"),o=t.dataTransfer.getData("group"),n=t.dataTransfer.getData("name"),i=t.dataTransfer.getData("label"),s=t.dataTransfer.getData("extras"),a=t.dataTransfer.getData("data"),r=s?JSON.parse(s):{};if(!e||!o||!n)return;let h;try{h=a?JSON.parse(a):{}}catch(t){console.error("Invalid drop data",t),h={}}const c=this.containerEl.getBoundingClientRect(),d=t.clientX-c.left-this.canvasX,m=t.clientY-c.top-this.canvasY;this.emit(l,{module:e,group:o,name:n,label:i,x:d,y:m,data:h,extras:r}),console.debug("FLOW - DROP: ",e,o,n,i,d,m,h,r)}catch(t){console.error("Invalid drop data",t)}}}class V extends G{constructor({model:t,view:e,behaviors:o=new Set}){super({name:`node-${t.id}`}),this.id=t.id,this.name=t.name,this.model=t,this.view=e,this.behaviors=o,this.destroyed=!1}html(){return""}setBehaviors(t){this.behaviors=t}addBehavior(t){this.behaviors.add(t)}removeBehavior(t){this.behaviors.delete(t)}renderInto(t){this.view.renderInto(t)}init(){this.behaviors.forEach(t=>{try{t._attach()}catch(e){console.error("Failed to attach behavior",t,e)}})}move(t,e){this.model.move(t,e),this.view.move(),this.emit(s,{id:this.id,x:t,y:e})}onResize(t,e){const{x:o,y:n}=this.model;this.model.resize(t,e),this.view.resizeNode(),this.emit(h,{id:this.id,x:o,y:n,w:t,h:e})}destroy(){this.behaviors.forEach(t=>t.detach?.()),this.behaviors.clear(),this.view.destroy(),this.view=null,this.behaviors=null,this.model=null,this.destroyed=!0}isCapabilitySupported(t){return this.model.capabilities.includes(t)}get x(){return this.model.x}get y(){return this.model.y}get w(){return this.model.w}get h(){return this.model.h}get label(){return this.model.label}select(t,e){this.view.setSelected(!0),this.emit(a,{id:this.model.id,cx:t,cy:e})}deselect(){this.view.setSelected(!1),this.emit(r,{id:this.model.id})}}class X{constructor({id:t,name:e,label:o,module:n="default",group:i="default",inputs:s=1,outputs:a=1,x:r=0,y:l=0,h:h=100,w:c=200,data:d={},capabilities:m=L,extras:u={}}){this.id=t,this.module=n,this.group=i,this.name=e,this.inputs=s,this.outputs=a,this.x=r,this.y=l,this.h=h,this.w=c,this.data=d,this.capabilities=m,this.label=o??this.name,this.extras=u}move(t,e){this.x=t,this.y=e}resize(t,e){this.w=t,this.h=e}}const U=new class{constructor(){this.views=new Map}register(t){const e=t.modelDefaults;this.views.set(e.module+":"+e.group+":"+e.name,t)}get(t,e,o){return this.views.get(t+":"+e+":"+o)}};class K extends G{constructor(t,e={}){if(!(t instanceof X))throw new Error("Model must be an instance of NodeModel");super({name:`node-${t.id}`}),this.model=t,this.options=e,this.el=null,this.contentId=`content-${t.id}`,this.zoomGetter=e.zoomGetter||(()=>this.options.zoom??1),this._content=null,this.close=null}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:70,label:"Node",group:"default",module:"default",capabilities:L,data:{}}}html(){return this._content=this.getNodeElement(),"string"==typeof this._content?this._content:""}init(){this.el=this.container,this.updateContainerAttributes(),this._content&&("string"==typeof this._content?this.el.innerHTML=this._content:this.el.appendChild(this._content)),this.createAllPorts(),this._bindEvents(),this.bindEvents()}updateContainerAttributes(){this.container.dataset.id="node-"+this.model.id,this.container.dataset.name=this.model.name,this.container.dataset.module=this.model.module,this.container.dataset.group=this.model.group,this.container.style.top=`${this.model.y}px`,this.container.style.left=`${this.model.x}px`,this.container.style.width=`${this.model.w}px`,this.container.style.height=`${this.model.h}px`,this.container.style.position="absolute",this.container.classList.add("flow-node")}createAllPorts(){const t=this.createPorts({type:"input",count:this.model.inputs}),e=this.createPorts({type:"output",count:this.model.outputs}),o=this.createClose();this.close=o,this.el.prepend(t),this.el.appendChild(e)}destroy(){console.log("FLOW: Destroying node view",this.model.id),this.el?.remove(),this.el=null}propagateEvent(t,e){e.on(t,e=>this.emit(t,e))}querySelector(t){return this.el.querySelector(t)}setSelected(t){this.el.classList.toggle("selected",t)}move(){this.el.style.top=`${this.model.y}px`,this.el.style.left=`${this.model.x}px`}getPortPosition({type:t,index:e}){if(!this.el)return null;const o=this.el.querySelector(`.flow-port[data-type="${t}"][data-index="${e}"]`);if(!o)return null;const n=this.el.getBoundingClientRect(),i=o.getBoundingClientRect(),s="function"==typeof this.zoomGetter?this.zoomGetter():1,a=(i.left-n.left+i.width/2)/s,r=(i.top-n.top+i.height/2)/s;return{x:this.model.x+a,y:this.model.y+r}}getBounds(){const t=this.el;return{left:t.offsetLeft,top:t.offsetTop,right:t.offsetLeft+t.offsetWidth,bottom:t.offsetTop+t.offsetHeight,width:t.offsetWidth,height:t.offsetHeight}}createPorts({type:t,count:e}){const o=document.createElement("div");o.className=`flow-ports-column flow-ports-${t}`;for(let n=0;n<e;n++){const e=document.createElement("div");e.className="flow-port",e.dataset.type=t,e.dataset.index=n,e.dataset.nodeId=this.model.id,o.appendChild(e)}return o}createClose(){const t=document.createElement("button");return t.className="btn-danger btn-close node-close border rounded shadow-none m-1",t.dataset.nodeId=this.model.id,t.setAttribute("aria-label","Close"),t}_bindEvents(){console.debug("FLOW: Bind events",this.name),this.bindMouseDown(),this.bindRemoveNode(),this.bindOutputPorts(),this.bindInputPorts()}bindRemoveNode(){this.el.querySelector(".node-close")?.addEventListener("click",t=>{t.stopPropagation(),this.emit(i,{id:this.model.id})})}bindMouseDown(){this.el.addEventListener("mousedown",t=>{this.emit("node:pointer:down",{event:t})})}bindInputPorts(){this.el.querySelectorAll(".flow-ports-input .flow-port").forEach(t=>{t.addEventListener("mouseup",e=>{console.debug("FLOW: Port connect end",e),this.emit(m,{nodeId:this.model.id,portIndex:t.dataset.index,event:e})})})}bindOutputPorts(){this.el.querySelectorAll(".flow-ports-output .flow-port").forEach(t=>{t.addEventListener("mousedown",e=>{console.debug("FLOW: Port connect start",e),this.emit(d,{nodeId:this.model.id,portIndex:t.dataset.index,event:e})})})}resizeNode(){this.el.style.width=`${this.model.w}px`,this.el.style.height=`${this.model.h}px`,this.resize?.()}attachEvent(t,e){this.el.addEventListener(t,e)}detachEvent(t,e){this.el.removeEventListener(t,e)}getNodeElement(){}bindEvents(){}}class J extends K{constructor(t,e={}){super(t,e)}static get name(){return"default-node-view"}getNodeElement(){return`\n        <div class="node" style="display: grid; place-items: center;">\n            <div class="node-label">${this.model.label}</div>\n        </div>\n    `}}class Q extends G{constructor({name:t,canvasContainer:e,zoomGetter:o=()=>1,View:n=J,viewRegistry:i=U,behaviorRegistry:s=_}){super({name:t+"node-manager"}),this.canvasContainer=e,this.zoomGetter=o,this.View=n,this.viewRegistry=i,this.nodes=new Map,this.idCounter=1,this.behaviorRegistry=s,this.type="node"}dropNode(t){console.debug("FLOW: Drop node",t),this.addNode(t,!0)}addNode(t,e=!1){console.debug("FLOW: Add node",t);let o=this.viewRegistry.get(t.module,t.group,t.name);o||(console.warn("No nodeview fond for {",t.module,t.group,t.name,"}. Using default view."),o=this.View);const n=o.modelDefaults;if(e){const e=this.zoomGetter(),o=t.h??n.h??100,i=t.w??n.w??200,s=(t.x-i/2)/e,a=(t.y-o/2)/e;t.x=s,t.y=a}Object.keys(n).forEach(e=>{const o=t[e];void 0!==o&&"undefined"!==o||(t[e]=n[e])});const i=this.#e(t,o);return i.renderInto(this.canvasContainer),i.init(),this.nodes.set(i.id,i),i.id}#e(t,e){const o=this.idCounter++,n=new X({id:o,...t}),l=new e(n,{...this.options,zoomGetter:this.zoomGetter}),u=new V({model:n,view:l}),p=this.behaviorRegistry.resolve(u,{component:u,options:this.options});return u.setBehaviors(p),this.propagateEvent(d,l),this.propagateEvent(m,l),this.propagateEvent(a,u),this.propagateEvent(r,u),this.propagateEvent(s,u),this.propagateEvent(h,u),this.propagateEvent(c,u),l.on(i,t=>this.removeNode(t.id)),u}removeNode(t){let e=this.getNode(t);e&&(e.destroy(),this.nodes.delete(t),this.emit(i,{id:t}),e=null)}remove(t){this.removeNode(t)}propagateEvent(t,e){console.debug("FLOW: Propagate event",t,e),e.on(t,e=>this.emit(t,e))}reset(){this.nodes.forEach(t=>{console.log("FLOW: Destroying node",t.id),t.destroy()}),this.nodes.clear(),this.idCounter=1,console.log("FLOW: Node manager reset",this.nodes)}getNode(t){return this.nodes.get(t)}getAllNodes(){return[...this.nodes.values()]}get size(){return this.nodes.size}}class tt{constructor(t,e={}){this.stroke=e.stroke??void 0,this.width=e.width??2,this.dash=e.dash??null,this.animated=!!e.animated,this.path=t??v,j.has(this.path)||(console.warn(`Path ${this.path} not found. setting to default path type ${v}.`),this.path=v),this.arrows={start:e.arrows?.start??!1,end:e.arrows?.end??!0},this.bad=!1,this.hover=!1,this.selected=!1,this.temp=!1,this.execution=e.execution??!1,this.speed=e.execution_speed??2}markBad(t=!0){this.bad=t}markHover(t=!0){this.hover=t}markSelected(t=!0){this.selected=t}markTemp(t=!0){this.temp=t}markExecution(t=!0){this.execution=t}applyTo(t){this.stroke&&(t.style.stroke=this.stroke),t.style.strokeWidth=this.width,t.style.strokeDasharray=this.dash??"",t.classList.toggle("animated",this.animated),t.classList.toggle("flow-connection-temp",this.temp),t.classList.toggle("flow-connection-path-bad",this.bad),t.classList.toggle("selected",this.selected),t.classList.toggle("path-hover",this.hover),this.execution?(t.style.strokeDasharray="6 4",t.style.animation=`flow ${1/this.speed}s linear infinite`):(t.style.strokeDasharray=this.dash??"",t.style.animation="")}}class et extends G{constructor({id:t,outNodeId:e,outPort:o,inNodeId:n,inPort:i,capabilities:s=I,options:a={}}){super({name:`connection-${t}`}),this.id=t,this.outNodeId=e,this.outPort=o,this.inNodeId=n,this.inPort=i,this.options=a,this.style={width:2,dash:null,animated:!1,...a.style},this.pathType=a.pathType??v,this.style=new tt(this.pathType,this.style),this.capabilities=s}get source(){return{nodeId:this.outNodeId,portIndex:this.outPort}}get target(){return{nodeId:this.inNodeId,portIndex:this.inPort}}get arrows(){return this.style.arrows}}class ot extends G{#o=null;#n=null;constructor({model:t,nodeManager:e,options:o={}}){super({name:`connection-view-${t.id}`}),this.model=t,this.nodeManager=e,this.path=null,this.shadowPath=null,this.options=o,this.container=null,this.#o=null,this.#n=null,this.adjustEnd=!1,this.adjustStart=!1,this.adjustOffset=6,this.endMarker=!0,this.startMarker=!0,this.isTemp=o.isTemp??!1}html(){return""}init(){this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.path.classList.add("flow-connection-path","connection"),this.path.setAttribute("id",this.model.id),this.parentContainer.appendChild(this.path),this.container=this.path,this.initShadowPath(),this.applyArrows(),this.el=this.path}static getConnectionKey(t,e,o,n){return`${t}:${e}-${o}:${n}`}applyArrows(){const t=this.model.arrows||{};this.endMarker=t.end??this.endMarker,this.startMarker=t.start??this.startMarker,this.path.removeAttribute("marker-start"),this.path.removeAttribute("marker-end"),this.startMarker&&(this.adjustStart=!0,this.path.setAttribute("marker-start","url(#arrow-start)")),this.endMarker&&(this.adjustEnd=!0,this.path.setAttribute("marker-end","url(#arrow-end)"))}initShadowPath(){this.shadowPath=document.createElementNS("http://www.w3.org/2000/svg","path"),this.shadowPath.classList.add("flow-connection-path","shadow-path"),this.shadowPath.setAttribute("id","shadow-"+this.model.id),this.shadowPath.style.stroke="transparent",this.shadowPath.style.strokeWidth=18,this.shadowPath.style.fill="none",this.shadowPath.style.pointerEvents=this.isTemp?"none":"stroke",this.parentContainer.appendChild(this.shadowPath)}applyStyle(){this.model.style.applyTo(this.path)}#i(t,e){let o=t,n=e;return this.adjustEnd&&(n={x:e.x-this.adjustOffset,y:e.y}),this.adjustStart&&(o={x:t.x+this.adjustOffset+16,y:t.y}),{p1:o,p2:n}}update(t,e,o={}){if(!t||!e)return;const n=t.view.getPortPosition({type:"output",index:this.model.source.portIndex}),i=e.view.getPortPosition({type:"input",index:this.model.target.portIndex});n&&i&&this.#s(n,i,o)}updateTempPath(t,e,o={}){this.model.style.markTemp(!0),this.path.style.pointerEvents="none",this.#s(t,e,o)}#s(t,e,o={}){const n=this.#i(t,e);this.updatePath(n.p1,n.p2,o)}updatePath(t,e,o={}){const n=this.model.pathType??"bezier";this.#o=t??this.#o,this.#n=e??this.#n;const i=j.get(n)({p1:this.#o,p2:this.#n,...o,zoom:this.options.zoom});this.shadowPath.setAttribute("d",i),this.path.setAttribute("d",i),this.path.setAttribute("p1x",t.x),this.path.setAttribute("p1y",t.y),this.path.setAttribute("p2x",e.x),this.path.setAttribute("p2y",e.y),this.applyStyle(),this.applyArrows()}addStyleClass(t){this.path.classList.add(t)}removeStyleClass(t){this.path.classList.remove(t)}destroy(){console.log("FLOW: Destroying connection view",this.model.id),this.path?.remove(),this.shadowPath?.remove(),this.path=null,this.shadowPath=null}bindEvents(){this.bindShadowSelect()}bindShadowSelect(){this.shadowPath.addEventListener("mouseover",t=>{t.stopPropagation(),this.model.style.markHover(!0),this.applyStyle()}),this.shadowPath.addEventListener("mouseout",t=>{t.stopPropagation(),this.model.style.markHover(!1),this.applyStyle()})}getBounds(){const t=this.el;if(!t)return null;const e=t.getTotalLength(),o=t.getPointAtLength(e/2),n=t.ownerSVGElement.createSVGPoint();n.x=o.x,n.y=o.y;const i=n.matrixTransform(t.getScreenCTM());return{centerX:i.x,centerY:i.y}}setSelected(t){this.model.style.markSelected(t),this.applyStyle()}attachEvent(t,e){this.path.addEventListener(t,e),this.shadowPath.addEventListener(t,e)}detachEvent(t,e){this.path.removeEventListener(t,e),this.shadowPath.removeEventListener(t,e)}}class nt extends G{constructor({model:t,view:e,nodeManager:o,behaviors:n=new Set}){super({name:`connection-${t.id}`}),this.model=t,this.view=e,this.nodeManager=o,this.destroyed=!1,this._source=null,this._target=null,this.behaviors=n,this.id=this.model.id}get outNodeId(){return this.model.outNodeId}get inNodeId(){return this.model.inNodeId}get inPort(){return this.model.inPort}get outPort(){return this.model.outPort}get source(){return this._source||(this._source={nodeId:this.model.source.nodeId,portIndex:this.model.source.portIndex}),this._source}get target(){return this._target||(this._target={nodeId:this.model.target.nodeId,portIndex:this.model.target.portIndex}),this._target}renderInto(t){this.view.renderInto(t),this.init()}init(){this.update(),this.attachBehaviors()}update(){const t=this.nodeManager.getNode(this.model.source.nodeId),e=this.nodeManager.getNode(this.model.target.nodeId),o={sourceBounds:t.view.getBounds(),targetBounds:e?.view.getBounds()};this.view.update(t,e,o)}updateWithXY(t,e){const o=this.nodeManager.getNode(this.source.nodeId);if(!o)return;const n=o.view.getPortPosition({type:"output",index:this.source.portIndex}),i={x:t,y:e},s={sourceBounds:o.view.getBounds()};this.view.updateTempPath(n,i,s)}markBadPath(){this.model.style.markBad(!0),this.view.applyStyle()}destroy(){this.view.destroy(),this.view=null,this.model=null,this.nodeManager=null,this.destroyed=!0}clearBadPath(){this.model.style.markBad(!1),this.view.applyStyle()}setPathStyle(t){this.model.pathType=t,this.update()}select(t,e){this.view.setSelected(!0),this.emit(g,{id:this.model.id,cx:t,cy:e})}deselect(){this.view.setSelected(!1),this.emit(y,{id:this.model.id})}setBehaviors(t){this.behaviors=t}addBehavior(t){this.behaviors.add(t)}removeBehavior(t){this.behaviors.delete(t)}attachBehaviors(){this.behaviors.forEach(t=>{try{t._attach()}catch(e){console.error("Failed to attach behavior",t,e)}})}isCapabilitySupported(t){return this.model.capabilities.includes(t)}}class it extends G{constructor({name:t,connectionContainer:e,nodeManager:o,behaviorRegistry:n=F,options:i={}}){super({name:t+"-flow-connection-manager",options:i}),this.connectionContainer=e,this.nodeManager=o,this.options=i,this.zoom=i.zoom||1,this.originalZoom=this.zoom,this.nodeIdCounter=1,this.nodeWidth=i.nodeWidth||200,this.nodeHeight=i.nodeHeight||90,this.connections=new Map,this.tempConnection=null,this.badConnections=new Set,this.behaviorRegistry=n,this.type="connection"}addConnection(t,e,o,n,i=void 0){const s=ot.getConnectionKey(t,e,o,n),a=this.#a({id:s,outNodeId:t,outPort:e,inNodeId:o,inPort:n,pathType:i,isTemp:!1});return this.connections.set(s,a),a}beginTempConnection(t,e,o=void 0){const n=this.#a({id:"temp",outNodeId:t,outPort:e,inNodeId:null,inPort:null,pathType:o,isTemp:!0});return this.tempConnection=n,n}#a({id:t,outNodeId:e,outPort:o,inNodeId:n,inPort:i,pathType:s,isTemp:a=!1}){const r=s??this.options?.connection?.path_type??v,l={...this.options?.connection,pathType:r},h=new et({id:t,outNodeId:e,outPort:o,inNodeId:n,inPort:i,options:l}),c=new ot({model:h,options:{...l,isTemp:a}}),d=new nt({model:h,view:c,nodeManager:this.nodeManager,options:l}),m=this.behaviorRegistry.resolve(d,{component:d,options:l});return d.setBehaviors(m),d.renderInto(this.connectionContainer.id),d.on(g,t=>{this.emit(g,t)}),d.on(y,t=>{this.emit(y,t)}),d}reset(){this.connections.forEach(t=>{console.debug("FLOW: Destroying connection",t.id),t.destroy()}),this.connections.clear(),this.clearTempPath?.(),console.debug("FLOW: Connection manager reset",this.connections)}updateConnections(t){const e=parseInt(t);this.connections.forEach((t,o)=>{t.source.nodeId!==e&&t.target.nodeId!==e||(t.update(),this.emit("connection:updated",t))})}updateTempConnection(t,e){this.tempConnection&&(this.clearBadPaths(),this.tempConnection.updateWithXY(t,e))}removeConnection(t){const e=this.getConnection(t);this.emit(p,t),this.connections.delete(t),e?.destroy()}remove(t){this.removeConnection(t)}removeRelatedConnections(t){this.connections.forEach((e,o)=>{e.source.nodeId!==t&&e.target.nodeId!==t||this.removeConnection(o)})}endTempConnection(){this.clearTempPath(),this.tempConnection=null}clearTempPath(){this.clearBadPaths(),this.tempConnection&&(this.tempConnection.destroy(),this.tempConnection=null)}markTempPathBad(){this.tempConnection&&this.markPathBad(this.tempConnection)}markPathBad(t){t.markBadPath(),this.badConnections.add(t)}clearBadPaths(){this.badConnections.forEach(t=>{t.clearBadPath()}),this.badConnections.clear()}getZoom(){return this.zoom}getAllConnections(){return[...this.connections.values()]}getConnection(t){return this.connections.get(t)}get size(){return this.connections.size}}class st{export(t){const e=t.nodeManager,o=t.connectionManager,n=t.canvas,i=[];e.getAllNodes().forEach(t=>{i.push(t.model)});const s=[];return o.getAllConnections().forEach(t=>{s.push(t.model)}),{nodes:i,connections:s,zoom:n.zoom,canvas:{x:n.canvasX,y:n.canvasY}}}import(t,e){const{nodeManager:o,connectionManager:n,canvas:i}=t,s=e.zoom||1;t.zoom=s,i.zoom=s,o.zoom=s,n.zoom=s,i.canvasX=e.canvas?.x||0,i.canvasY=e.canvas?.y||0,i.redrawCanvas(),o.reset?.(),n.reset?.(),e.nodes&&e.nodes.forEach(t=>{o.addNode(t)}),e.connections&&e.connections.forEach(e=>{t.addConnection(e.outNodeId,e.outPort,e.inNodeId,e.inPort)})}}class at extends G{constructor({selection:t,options:e={}}){super({name:"floxy-selection-toolbar"}),this.selection=t,this.options=e,this.x=null,this.y=null}html(){return'\n        <div id="floxy-selection-toolbar-btn-group" class="list-group tools list-group-horizontal-sm floxy-selection-toolbar" style="width: fit-content;">\n        </div>'}init(){this.container=this.container.querySelector("#floxy-selection-toolbar-btn-group"),this.updateView()}updateView(){if(this.container.innerHTML="",this.container.style.zIndex="1000",this.container.style.height="fit-content",!this.selection.active)return void(this.container.style.display="none");this.container.style.display="flex",this.container.style.position="absolute";[...this.selection.commands].sort((t,e)=>(t.constructor.order??0)-(e.constructor.order??0)).forEach(t=>{const e=document.createElement("a");e.classList.add("list-group-item"),e.classList.add("tool-item"),t.constructor.icon?e.innerHTML=t.constructor.icon:e.textContent=t.constructor.label,t.constructor.toolclass&&e.classList.add(t.constructor.toolclass),e.onclick=()=>{this.selection.execute(t.constructor.capability)&&t.clearSelection&&this.updateView()},this.container.appendChild(e)}),this.position()}position(){const t=this.selection.getBounds();if(t)if(this.selection.cx){const t=this.selection.cx,e=this.selection.cy+16;this.container.style.left=`${t}px`,this.container.style.top=`${e}px`}else{const e=this.container.offsetWidth;this.container.style.left=t.left+t.width/2-e/2+5+"px",this.container.style.top=`${t.top+t.height+16}px`}}hide(){this.container.style.display="none"}show(){this.container.style.display="block"}}class rt{constructor(t,e={}){this.flow=t,this.options=e,this.component=null,this.manager=null,this.commands=new Set,this.cx=null,this.cy=null,this.notification=e.notification}get active(){return null!==this.component&&null!==this.manager}set(t,e,o,n,i){this.manager=e,this.component=t,this.cx=n,this.cy=i,this.commands=o.resolve(t,{options:this.options})}clear(){this.component=null,this.manager=null,this.cx=null,this.cy=null,this.commands=new Set}execute(t){let e=!1;console.debug("Executing capability: ",t,this.commands);const o=[...this.commands].find(e=>e.constructor.capability===t);return o?(e=o?.run(this.flow,this.manager,this.component),e&&o.clearSelection&&this.clear()):this.notification?.error(`${this.component?.label} is not ${t}.`),e}getBounds(){return this.component?.view?.getBounds?this.component.view.getBounds():null}}class lt{onConnectionAttempt({outNodeId:t,inNodeId:e}){return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:e}){}onConnectionRemoved({outNodeId:t,inNodeId:e}){}}class ht{constructor(t=document.documentElement){this.root=t,this.root.hasAttribute("data-floxy-grid-type")||this.root.setAttribute("data-floxy-grid-type","dots");const e=localStorage.getItem("floxy-theme")||"system";this.setGlobalTheme(e)}getGlobalTheme(){return this.root.getAttribute("data-floxy-theme")||"light"}setGlobalTheme(t){let e=t;"system"===t&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),this.root.setAttribute("data-floxy-theme",e),localStorage.setItem("floxy-theme",t)}setToken(t,e){this.root.style.setProperty(`--floxy-${t}`,e),"grid-type"===t&&this.root.setAttribute("data-floxy-grid-type",e)}setTheme(t){Object.entries(t).forEach(([t,e])=>{this.setToken(t,e)})}getToken(t){return"global-theme"===t?localStorage.getItem("floxy-theme")||"system":getComputedStyle(this.root).getPropertyValue(`--floxy-${t}`).trim()}}class ct extends K{constructor(t,e={}){super(t,e),this.shapeName="svg",this.shape=null,this.label=null}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:150,label:"SVG",module:"default",group:"default",name:"svg",capabilities:L,data:{}}}getNodeElement(){const t=document.createElement("div");t.className=`flow-node ${this.shapeName}-node`;const e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.classList.add("node"),this.shape=this.createShape(),this.label=this.createLabel(),this.shape.classList.add("shape"),e.appendChild(this.shape),t.appendChild(e),t.appendChild(this.label),t}init(){super.init(),this.resize()}createLabel(){const t=document.createElement("div");return t.classList.add("node-label"),t.setAttribute("contenteditable",!1),t.textContent=this.model.label,t}createShape(){if(!k.includes(this.shapeName))throw new Error(`Can not create give ${this.shapeName} svg shape`);return document.createElementNS("http://www.w3.org/2000/svg",this.shapeName)}resize(){throw new Error("Method 'resize()' must be implemented in the subclass")}}const dt=[C,E.MOVABLE,E.EDITABLE_LABEL,E.REMOVABLE];const mt=[E.MOVABLE,E.EDITABLE_LABEL,E.RESIZABLE,E.SELECTABLE,E.REMOVABLE];return _.register(class extends T{static get capability(){return E.MOVABLE}gaurd(){return"function"==typeof this.node.view.move||(console.warn("Node view does not have move method to support draggable behavior"),!1)}attach(){const t=this.node.view;this.dragHandler=new A(t.el,(t,e)=>{this.node.move(t,e)},{x:this.node.x,y:this.node.y},{x:0,y:0},t.zoomGetter),this.dragHandler.registerDragEvent()}detach(){this.dragHandler?.destroy()}}),_.register(class extends P{constructor({component:t,options:e={}}){super({component:t,options:e}),this.node=this.component}static get capability(){return C}static get removal_event(){return i}static get select_event(){return a}static get deselect_event(){return r}}),_.register(class extends T{static get capability(){return E.EDITABLE_LABEL}gaurd(){const t=this.node.view.el.querySelector(".node-label");return t?(this._el=t,!0):(console.warn("Node view does not have label element to support editable label behavior"),!1)}attach(){if(!this._el)return;this._onDblClick=(t=>{t.stopPropagation(),this._el.contentEditable="true",this._el.focus(),document.execCommand("selectAll",!1,null)}).bind(this),this._onBlur=(()=>{this._el.contentEditable="false",this.node.model.label=this._el.textContent.trim(),this.node.emit(c,{id:this.node.id,label:this.node.model.label})}).bind(this),this._onKeyDown=(t=>{"Enter"===t.key&&(t.preventDefault(),this._el.blur())}).bind(this),this._el.addEventListener("dblclick",this._onDblClick),this._el.addEventListener("blur",this._onBlur),this._el.addEventListener("keydown",this._onKeyDown)}detach(){this._el&&(this._el.removeEventListener("dblclick",this._onDblClick),this._el.removeEventListener("blur",this._onBlur),this._el.removeEventListener("keydown",this._onKeyDown),this._el=null)}}),_.register(class extends T{static get capability(){return E.RESIZABLE}attach(){const t=this.node.view.el,e=this.node.view;this.handle=document.createElement("div"),this.handle.className="resize-handle resize-br",t.appendChild(this.handle),this.dragHandler=new A(this.handle,(t,e)=>{const o=Math.max(150,t-this.node.x),n=Math.max(50,e-this.node.y);this.node.onResize(o,n)},{x:this.node.x+this.node.w,y:this.node.y+this.node.h},{x:0,y:0},e.zoomGetter,"nwse-resize","nwse-resize"),this.dragHandler.registerDragEvent()}detach(){this.handle?.remove(),this.dragHandler?.destroy()}}),R.register(D),F.register(class extends P{constructor({component:t,options:e={}}){super({component:t,options:e}),this.connection=this.component}static get capability(){return C}static get removal_event(){return p}static get select_event(){return g}static get deselect_event(){return y}}),Z.register(D),Z.register(O),Z.register(H),Z.register(W),U.register(class extends K{constructor(t,e={}){super(t,e)}static get name(){return"form-node-view"}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:0,label:"Form Node",module:"workflow",group:"form",name:"form",capabilities:dt,data:{}}}getNodeElement(){const t=this.model.extras.html_function;let e="<p style='color: var(--floxy-danger-color);'>HTML function not found to load form node.</p>";return window.flow_form_functions&&window.flow_form_functions[t]&&(e=window.flow_form_functions[t]()),`\n        <div class="node form-node" style="display: grid; place-items: center; height: fit-content;">\n            <div class="node-label">${this.model.label}</div>\n            <form class="form-node-body">${e}</form>\n        </div>\n    `}bindEvents(){const t=this.el.querySelector(".form-node-body");this.model.data.customHtml&&(t.innerHTML=this.model.data.customHtml),this.model.data.form_values||(this.model.data.form_values={});this.el.querySelectorAll(".form-node-body input").forEach(e=>{if(!e.name)return console.error("Input name is required"),void(t.innerHTML="<p style='color: var(--floxy-danger-color);'>Input name is required to load form.</p>")}),this.addPasswordEyeIcon(),this.loadInitFormData(),t.addEventListener("input",t=>{this.model.data.form_values[t.target.name]=t.target.value}),this.container.style.height="fit-content",this.container.style.width="fit-content",t.addEventListener("mousedown",t=>t.stopPropagation()),t.addEventListener("keydown",t=>t.stopPropagation())}loadInitFormData(){this.el.querySelector(".form-node-body").querySelectorAll("input").forEach(t=>{this.model.data.form_values[t.name]&&(t.value=this.model.data.form_values[t.name])})}addPasswordEyeIcon(){this.el.querySelectorAll(".form-node-body input[type=password]").forEach(t=>{const e=document.createElement("i");e.className="bi bi-eye flow-eye",e.style.cursor="pointer",e.style.position="absolute",e.style.right=".75rem",e.style.top="55%",e.style.opacity="0.5",t.parentNode.style.position="relative",t.parentNode.appendChild(e),e.addEventListener("click",()=>{"password"===t.type?(t.type="text",e.className="bi bi-eye-slash"):(t.type="password",e.className="bi bi-eye")})})}}),U.register(class extends ct{constructor(t,e={}){super(t,e),this.shapeName="ellipse",this.ellipse=null}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:150,label:"Action",module:"diagram",group:"workflow",name:"action",capabilities:mt,data:{}}}createShape(){const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return this.ellipse=t,this.ellipse}updateShape(){}resize(){const{w:t,h:e}=this.model,o=(t-1)/2,n=(e-1)/2;this.ellipse.setAttribute("cx",o),this.ellipse.setAttribute("cy",n),this.ellipse.setAttribute("rx",o),this.ellipse.setAttribute("ry",n)}}),t.DagValidator=class extends lt{constructor({enabled:t=!0}={}){super(),this.enabled=t,this.adjacencyList={},this.nonCyclicCache={},this.tempCyclicCache={},this.tempStackCache={}}onConnectionAttempt({outNodeId:t,inNodeId:e}){const o="This connection will create cyclic flow.";if(!this.enabled)return{valid:!0};const n=`${t}->${e}`;if(void 0!==this.nonCyclicCache[n])return{valid:!this.nonCyclicCache[n]};if(this.tempCyclicCache[n])return{valid:!1,stack:this.tempStackCache[n],message:o};this.tempStackCache[n]=[];const i=this.tempStackCache[n],s=new Set;let a=new Set(this.adjacencyList[t]||new Set);a.add(e),s.add(t),i.push(t);for(const t of a)if(this.#r(t,s,i))return this.tempCyclicCache[n]=!0,{valid:!1,stack:i,message:o};return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:e}){this.#l(t,e),this.#h(t,e)}onConnectionRemoved({outNodeId:t,inNodeId:e}){const o=`${t}->${e}`;this.adjacencyList[t]?.delete(e),delete this.nonCyclicCache[o],this.tempCyclicCache={}}#l(t,e){this.adjacencyList[t]||(this.adjacencyList[t]=new Set),this.adjacencyList[t].add(e)}#h(t,e){const o=`${t}->${e}`;this.nonCyclicCache[o]=!1,delete this.tempStackCache[o]}#r(t,e,o){if(o.includes(t))return o.push(t),!0;if(e.has(t))return!1;e.add(t),o.push(t);for(const n of this.adjacencyList[t]||[])if(this.#r(n,e,o))return!0;return o.pop(),!1}},t.Flow=class extends G{constructor({name:t,options:e={},validators:o=[],notification:n=null,nodeCommandRegistry:i=R,connectionCommandRegistry:s=Z,selectionManagerCls:a=rt}){super({name:t}),this.options=e,this.validators=o,this.notification=n,this.serializer=new st,this.zoom=e.zoom||1,this.originalZoom=this.zoom,this.nodes={},this.nodeIdCounter=1,this.canvasEl=null,this.svgEl=null,this.nodeManager=null,this.connectionManager=null,this.rafId=null,this.isConnecting=!1,this.commands=new Set,this.activeSelection=null,this.nodeCommandRegistry=i,this.connectionCommandRegistry=s,this.selectionManager=new a(this,{notification:this.notification}),this.toolbar=null,this.zoomInEl=null,this.zoomOutEl=null,this.zoomResetEl=null,this.defaultPathType=e.connection?.pathType||"bezier",this.availablePaths=[O,H,W]}html(){const t=this.availablePaths.map(t=>{const e=t.capability.slice(5),o=e.charAt(0).toUpperCase()+e.slice(1);return`<a href="#" class="list-group-item list-group-item-action tool-item ${e===this.defaultPathType?"active":""}" \n                  id="${this.id}-${e}" data-path="${e}">${t.icon} <span class="ms-2">${o}</span></a>`}).join("");return`<div class="list-group tools list-group-horizontal-sm zoom-actions" style="width: fit-content;">\n              <a href="#" class="list-group-item tool-item list-group-item-action zoom-item" id="${this.id}-zoomin" data-action="zoomin"><i class="bi bi-plus-lg"></i></a>                  \n              <a href="#" class="list-group-item tool-item list-group-item-action zoom-item" id="${this.id}-zoomreset" data-action="zoomreset"><i class="bi bi-justify"></i></a>\n              <a href="#" class="list-group-item tool-item list-group-item-action zoom-item" id="${this.id}-zoomout" data-action="zoomout"><i class="bi bi-dash-lg"></i></a>\n            </div>\n            <div class="list-group tools path-selection">\n              ${t}\n            </div>\n            `}init(){this.container.classList.add("floxy-flow-container"),this.canvas=new Y({name:this.name+"-canvas",options:this.options}),this.canvas.renderInto(this.container),this.containerEl=this.container,this.canvasEl=this.canvas.canvasEl,this.svgEl=this.canvas.svgEl,this.zoomInEl=this.containerEl.querySelector(`#${this.id}-zoomin`),this.zoomOutEl=this.containerEl.querySelector(`#${this.id}-zoomout`),this.zoomResetEl=this.containerEl.querySelector(`#${this.id}-zoomreset`),this.zoomInEl.addEventListener("click",this.onZoomAction.bind(this)),this.zoomOutEl.addEventListener("click",this.onZoomAction.bind(this)),this.zoomResetEl.addEventListener("click",this.onZoomAction.bind(this)),this.pathOptionsEls=this.containerEl.querySelectorAll(".list-group.tools.path-selection .list-group-item"),this.pathOptionsEls.forEach(t=>{t.addEventListener("click",this.onPathOptionAction.bind(this))}),this.nodeManager=new Q({name:this.name+"-flow-node-manager",canvasContainer:this.canvasEl,zoomGetter:()=>this.zoom,options:this.options}),this.connectionManager=new it({name:this.name+"-flow-connection-manager",connectionContainer:this.svgEl,nodeManager:this.nodeManager,options:this.options}),this.canvas.on(n,({data:t})=>{this.zoom=t.zoom,this.connectionManager.zoom=t.zoom,this.nodeManager.zoom=t.zoom,this.zoomChangeUpdate()}),this.nodeManager.on(a,({id:t,cx:e,cy:o})=>{const n=this.nodeManager.getNode(t);this.emit(a,{id:t,cx:e,cy:o}),this.selectionManager.set(n,this.nodeManager,this.nodeCommandRegistry),this.toolbar.updateView()}),this.nodeManager.on(r,({id:t})=>{this.selectionManager.clear(),this.toolbar.updateView()}),this.connectionManager.on(g,({id:t,cx:e,cy:o})=>{console.debug("Connection is selected: ",t),this.emit(g,{id:t,cx:e,cy:o});const n=this.connectionManager.getConnection(t);this._canvasRect||(this._canvasRect=this.canvasEl.getBoundingClientRect());const i=(e-this._canvasRect.left)/this.zoom,s=(o-this._canvasRect.top)/this.zoom;this.selectionManager.set(n,this.connectionManager,this.connectionCommandRegistry,i,s),this.toolbar.updateView()}),this.connectionManager.on(y,({id:t})=>{this.selectionManager.clear(),this.toolbar.updateView()}),this.canvas.on(l,t=>{console.debug("Node is dropped: ",t),this.emit(l,t),this.nodeManager.dropNode(t)}),this.nodeManager.on(s,({id:t,x:e,y:o})=>{this.emit(s,{id:t,x:e,y:o}),this.connectionManager.updateConnections(t),this.toolbar.hide()}),this.nodeManager.on(h,({id:t,x:e,y:o,w:n,h:i})=>{this.emit(h,{id:t,x:e,y:o,w:n,h:i}),this.connectionManager.updateConnections(t),this.toolbar.hide()}),this.nodeManager.on(i,({id:t})=>{console.debug("Node is removed: ",t),this.emit(i,{id:t}),this.removeNode(t),this.toolbar.updateView()}),this.nodeManager.on(d,({nodeId:t,portIndex:e,event:o})=>{this.isConnecting?console.debug("Already connection is being drawn. Ignoring this event."):(console.debug("Port connect start: ",t,e,o),this.mouseDownStartConnection({dataset:{index:e}},t,o))}),this.nodeManager.on(m,({nodeId:t,portIndex:e,event:o})=>{console.debug("Port connect end: ",t,e,o),this.mouseUpCompleteConnection({dataset:{index:e}},t,o)}),this.connectionManager.on(u,t=>{console.debug("Connection is created: ",t),this.emit(u,t),this.validators.forEach(e=>e.onConnectionAdded?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))}),this.connectionManager.on(p,t=>{console.debug("Connection is removed: ",t),this.emit(p,t),this.validators.forEach(e=>e.onConnectionRemoved?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))}),this.bindCommandEvents(),this.toolbar=new at({selection:this.selectionManager}),this.toolbar.renderInto(this.canvasEl),this.zoomChangeUpdate()}bindCommandEvents(){window.addEventListener("keydown",t=>{const e=z[t.key];if(e&&this.selectionManager.active){this.selectionManager.execute(e)&&this.toolbar.updateView()}})}onZoomAction(t){t.preventDefault();switch(t.currentTarget.dataset.action){case"zoomin":this.zoom+=.1;break;case"zoomout":this.zoom-=.1;break;case"zoomreset":this.zoom=this.originalZoom}this.canvas.handleZoomChange(this.zoom)}zoomChangeUpdate(){this.zoom===this.originalZoom?(this.zoomInEl.classList.remove("active"),this.zoomOutEl.classList.remove("active")):this.zoom>this.originalZoom?(this.zoomInEl.classList.add("active"),this.zoomOutEl.classList.remove("active")):(this.zoomInEl.classList.remove("active"),this.zoomOutEl.classList.add("active"))}onPathOptionAction(t){t.preventDefault();const e=t.currentTarget.dataset.path;this.defaultPathType=e,this.pathOptionsEls.forEach(t=>{t.classList.remove("active")}),t.currentTarget.classList.add("active")}highlightCycle(t){if(t&&!(t.length<2)){console.debug("FLOW: highlight cycle",t);for(let e=0;e<t.length-1;e++){const o=this.connectionManager.getAllConnections().find(o=>o.outNodeId===t[e]&&o.inNodeId===t[e+1]);o&&this.connectionManager.markPathBad(o)}}}addNode(t){return this.nodeManager.addNode(t)}mouseDownStartConnection(t,e,o){console.debug("FLOW: Start connection from port: ",t,"nodeId: ",e),o.stopPropagation(),this.isConnecting=!0,this.connectionStart={nodeId:e,index:t.dataset.index},this.connectionManager.beginTempConnection(e,t.dataset.index,this.defaultPathType),this._drawConnection=o=>this.mouseMoveDrawConnection(t,e,o),this._cancelConnection=t=>this.keyDownCancelConnection(t,e),window.addEventListener("mousemove",this._drawConnection),window.addEventListener("keydown",this._cancelConnection),this.startRaf(()=>{const t=this.connectionStart.prevX==this.connectionStart.x&&this.connectionStart.prevY==this.connectionStart.y;this.connectionStart.x&&this.connectionStart.y&&!t&&(this.connectionStart.prevX=this.connectionStart.x,this.connectionStart.prevY=this.connectionStart.y,this.connectionManager.updateTempConnection(this.connectionStart.x,this.connectionStart.y))})}mouseMoveDrawConnection(t,e,o){if(this.isConnecting){this._canvasRect||(this._canvasRect=this.canvasEl.getBoundingClientRect());const t=this._canvasRect,e=(o.clientX-t.left)/this.zoom,n=(o.clientY-t.top)/this.zoom;this.connectionManager.updateTempConnection(e,n),this.connectionStart.x=e,this.connectionStart.y=n}}mouseUpCompleteConnection(t,e,o){if(this.isConnecting){const t=o.target.closest(".flow-port");if(t&&"input"===t.dataset.type){const n=parseInt(t.dataset.nodeId),i=parseInt(t.dataset.index);this.addConnection(this.connectionStart.nodeId,this.connectionStart.index,n,i,o,e)&&this.connectionManager.endTempConnection()}}}addConnection(t,e,o,n,i=null,s=null){for(const e of this.validators){const n=e.onConnectionAttempt({outNodeId:t,inNodeId:o});if(!n.valid)return this.notification?.warning(n.message),this.connectionManager.markTempPathBad(),n.stack&&this.highlightCycle(n.stack),!1}const a=this.connectionManager.addConnection(t,e,o,n,this.defaultPathType);return a&&(this.validators.forEach(e=>e.onConnectionAdded?.({outNodeId:t,inNodeId:o})),i&&this.keyDownCancelConnection(i,s)),a}keyDownCancelConnection(t,e){"keydown"==t.type&&"Escape"!==t.key&&27!==t.keyCode||(this.isConnecting=!1,this.connectionManager.endTempConnection(),this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection),this._drawConnection=null))}removeNode(t){this.connectionManager.removeRelatedConnections(t)}export(){return this.serializer.export(this)}import(t){this.serializer.import(this,t),this.zoomChangeUpdate()}startRaf(t){if(this.rafId)return;const e=()=>{if(!this.isConnecting)return cancelAnimationFrame(this.rafId),this.rafId=null,void(this._canvasRect=null);t(),this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}destroy(){this.isConnecting=!1,this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection)),cancelAnimationFrame(this.rafId)}},t.ThemeEditor=class extends G{constructor(t={}){super({name:"flow-theme-editor"}),this.manager=t.manager||new ht,this.isOpen=!1,this.config=[{category:"Global Appearance",tokens:[{name:"global-theme",label:"Color Theme",type:"select",options:[{label:"Light",value:"light"},{label:"Dark",value:"dark"},{label:"System",value:"system"}]}]},{category:"Brand Colors",group:!0,tokens:[{name:"primary-color",label:"Primary",type:"color"},{name:"secondary-color",label:"Secondary",type:"color"},{name:"danger-color",label:"Danger",type:"color"},{name:"warning-color",label:"Warning",type:"color"},{name:"info-color",label:"Info",type:"color"}]},{category:"Nodes",tokens:[{name:"node-bg",label:"Background",type:"color"},{name:"node-border",label:"Border",type:"color"},{name:"node-border-width",label:"Border Width",type:"range",min:0,max:10,unit:"px"},{name:"node-radius",label:"Corner Radius",type:"range",min:0,max:50,unit:"px"},{name:"node-focus-color",label:"Selected Color",type:"color"},{name:"node-focus-width",label:"Selected Width",type:"range",min:0,max:10,unit:"px"}]},{category:"Labels",tokens:[{name:"label-color",label:"Text Color",type:"color"},{name:"label-font-size",label:"Font Size",type:"range",min:8,max:24,unit:"px"}]},{category:"Ports",tokens:[{name:"port-size",label:"Size",type:"range",min:4,max:20,unit:"px"},{name:"port-radius",label:"Corner Radius",type:"range",min:0,max:50,unit:"%"},{name:"port-bg",label:"Input Background",type:"color"},{name:"port-output-bg",label:"Output Background",type:"color"},{name:"port-border",label:"Border",type:"color"}]},{category:"Connections",tokens:[{name:"conn-color",label:"Color",type:"color"},{name:"conn-width",label:"Width",type:"range",min:1,max:10,unit:"px"},{name:"conn-hover-color",label:"Hover Color",type:"color"},{name:"conn-selected-color",label:"Selected Color",type:"color"},{name:"conn-bad-color",label:"Bad Color",type:"color"}]},{category:"Grid",tokens:[{name:"grid-type",label:"Type",type:"select",options:[{label:"Dots",value:"dots"},{label:"Lines",value:"lines"}]},{name:"grid-dot-color",label:"Dot Color",type:"color"},{name:"grid-dot-size",label:"Dot Size",type:"range",min:10,max:100,unit:"px"},{name:"grid-dot-radius",label:"Dot Radius",type:"range",min:.5,max:5,step:.1,unit:"px"},{name:"grid-line-color",label:"Line Color",type:"color"},{name:"grid-line-size",label:"Line Size",type:"range",min:10,max:100,step:10,unit:"px"},{name:"grid-line-width",label:"Line Width",type:"range",min:1,max:5,unit:"px"}]}]}html(){return`      \n            <button class="floxy-toggle-btn" id="floxy-theme-toggle" title="Customize Theme">\n                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">\n                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>\n                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.185 1.184l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.184 1.185l-.292-.159a1.873 1.873 0 0 0-2.692 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.291.16c-.764.415-1.6-.42-1.185-1.184l.159-.292a1.873 1.873 0 0 0-1.116-2.692l-.318-.094c-.835-.246-.835-1.428 0-1.674l.319-.094a1.873 1.873 0 0 0 1.115-2.693l-.16-.291c-.415-.764.42-1.6 1.184-1.185l.292.159a1.873 1.873 0 0 0 2.692-1.116l.094-.318z"/>\n                </svg>\n            </button>\n            <div class="floxy-theme-editor swag" id="floxy-theme-panel">\n                <div class="floxy-theme-header">\n                    <h5 class="m-0 fw-bold" style="font-size: 0.95rem; color: var(--floxy-label-color);">Theme Editor</h5>\n                    <button type="button" class="btn-close" id="floxy-theme-close" style="font-size: 0.7rem; opacity: 0.6; color: var(--floxy-node-text);"></button>\n                </div>\n                <div class="floxy-theme-body">\n                    ${this.renderTokenControl()}\n                </div>\n                <div class="floxy-theme-footer">\n                    <button class="btn btn-sm btn-primary flex-grow-1 py-2" id="floxy-download-theme">Download Theme</button>\n                    <button class="btn btn-sm btn-outline-secondary flex-grow-1 py-2" id="floxy-export-css">Copy CSS</button>\n                    <button class="btn btn-sm btn-link w-100 mt-2" id="floxy-theme-reset" style="font-size: 0.75rem; text-decoration: none;  color: var(--floxy-secondary-color)">Reset Defaults</button>\n                </div>\n            </div>\n        `}render(){this.container.innerHTML=this.html(),this.attachEvents()}init(){this.render()}renderTokenControl(){return this.config.map(t=>`\n            <div class="floxy-theme-section">\n              ${this.#c(t)}\n            </div>\n          `).join("")}#c(t){const e=t.group??!1;let o=`<h6>${t.category}</h6>`;return e?(o+='<div style="display: flex; gap: 8px; flex-wrap: wrap;">',t.tokens.forEach(t=>{const e=this.manager.getToken(t.name);o+=`<input type="color" title="${t.label}" class="floxy-color-input" data-token="${t.name}" value="${this.rgbToHex(e)}">`}),o+="</div>",o):(o+=`${t.tokens.map(t=>this.#d(t)).join("")}`,o)}#d(t){return"color"===t.type?this.#m(t):"range"===t.type?this.#u(t):"select"===t.type?this.#p(t):void 0}#m(t){const e=this.manager.getToken(t.name);return`\n        <div class="floxy-token-row">\n          <span class="floxy-token-label">${t.label}</span>\n          <input type="color" class="floxy-color-input" data-token="${t.name}" value="${this.rgbToHex(e)}">\n        </div>\n      `}#u(t){const e=this.manager.getToken(t.name),o=parseFloat(e)||0;return`\n        <div class="floxy-token-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">\n          <div style="display: flex; justify-content: space-between; align-items: center;">\n            <span class="floxy-token-label">${t.label}</span>\n            <span class="floxy-range-value" id="val-${t.name}">${e}</span>\n          </div>\n          <input type="range" class="form-range floxy-range-input" \n            data-token="${t.name}" \n            data-unit="${t.unit||""}"\n            min="${t.min}" max="${t.max}" step="${t.step||1}" \n            value="${o}">\n        </div>\n      `}#p(t){const e=this.manager.getToken(t.name)||t.options[0].value;return`\n        <div class="floxy-token-row">\n          <span class="floxy-token-label">${t.label}</span>\n          <select class="form-select form-select-sm floxy-select-input w-50" data-token="${t.name}" style="font-size: 0.75rem;">\n            ${t.options.map(t=>`<option value="${t.value}" ${e===t.value?"selected":""}>${t.label}</option>`).join("")}\n          </select>\n        </div>\n      `}attachEvents(){const t=this.container.querySelector("#floxy-theme-panel"),e=this.container.querySelector("#floxy-theme-toggle"),o=this.container.querySelector("#floxy-theme-close"),n=this.container.querySelector("#floxy-theme-reset"),i=this.container.querySelector("#floxy-export-css"),s=this.container.querySelector("#floxy-download-theme");e.onclick=()=>{this.isOpen=!this.isOpen,t.classList.toggle("open",this.isOpen)},o.onclick=()=>{this.isOpen=!1,t.classList.remove("open")},t.querySelectorAll("input, select").forEach(t=>{const e=t=>{const e=t.target.dataset.token,o=t.target.dataset.unit||"",n=t.target.value+o;"global-theme"===e?this.manager.setGlobalTheme(t.target.value):this.manager.setToken(e,n);const i=this.container.querySelector(`#val-${e}`);i&&(i.textContent=n)};t.oninput=e,t.onchange=e}),n.onclick=t=>{t.preventDefault(),confirm("Reset all theme variables to defaults?")&&window.location.reload()},i.onclick=()=>{let t=":root {\n";this.config.forEach(e=>{e.tokens.forEach(e=>{t+=`  --floxy-${e.name}: ${this.manager.getToken(e.name)};\n`})}),t+="}",navigator.clipboard.writeText(t).then(()=>{const t=i.textContent;i.textContent="Copied!",i.classList.add("btn-success"),i.classList.remove("btn-outline-secondary"),setTimeout(()=>{i.textContent=t,i.classList.remove("btn-success"),i.classList.add("btn-outline-secondary")},2e3)})},s.onclick=()=>{let t="/* Generated by Floxy Theme Editor */\n:root {\n";this.config.forEach(e=>{e.tokens.forEach(e=>{t+=`  --floxy-${e.name}: ${this.manager.getToken(e.name)};\n`})}),t+="}";const e=new Blob([t],{type:"text/css"}),o=URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download="floxy-theme.css",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o)}}rgbToHex(t){if(t.startsWith("#"))return t;const e=t.match(/\d+/g);return!e||e.length<3?"#000000":"#"+e.slice(0,3).map(t=>{const e=parseInt(t).toString(16);return 1===e.length?"0"+e:e}).join("")}},t.ThemeManager=ht,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
