var floxy=function(t){"use strict";const e="canvas:zoom",n="node:removed",o="node:moved",s="node:selected",i="node:deselected",a="node:dropped",r="node:updated",h="node:label:updated",l="node:port:connect:start",d="node:port:connect:end",c="connection:created",p="connection:removed",m="connection:clicked",u="connection:selected",g="connection:deselected",v="bezier",y="selectable",w="selectable",b="movable",f="editable-label",C="resizable",x=[y,b,f,C],E=["ellipse","circle","rect","line","polyline","polygon","path"];class k{constructor({type:t,component:e,options:n={}}){this.component=e,this.type=t,this.options=n,this.attached=!1}static get behavior(){throw new Error("Static property behavior must be implemented in the subclass")}static get removal_event(){throw new Error("Static property removal_event must be implemented in the subclass")}isSupported(){const t=this.component.isCapabilitySupported(this.constructor.behavior);return console.debug("FLOW: Is behavior supported",this.constructor.behavior,t),t}_attach(){console.log(this.component),this.isSupported()&&this.gaurd()&&(this.attach(),this.attached=!0,this.component.on(this.constructor.removal_event,this.destroy))}gaurd(){return!0}attach(){throw new Error("Method 'attach()' must be implemented in the subclass")}detach(){throw new Error("Method 'detach()' must be implemented in the subclass")}destroy(){this.detach(),this.component.off(this.constructor.removal_event,this.destroy)}}class I extends k{static type="connection";constructor({type:t,component:e,options:n={}}){super({type:t,component:e,options:n}),this.connection=this.component}static get removal_event(){return p}}let S=null;function $(t){S=t}function P(){return S}class M extends I{constructor({type:t,component:e,options:n={}}){super({type:t,component:e,options:n}),this.selected=!1}static get behavior(){return y}attach(){const t=this.component.view;this._onPointerDown=(t=>{t.stopPropagation(),this.select()}).bind(this),t.attachEvent("click",this._onPointerDown)}select(){P()!==this&&(P()?.deselect(),this.selected=!0,this.component.select(),$(this))}deselect(){this.component.destroyed||this.component.deselect(),$(null),this.selected=!1}detach(){this._onPointerDown&&this.component?.view?.el&&this.component.view.detachEvent("click",this._onPointerDown)}static get select_event(){throw new Error("Static property select_event must be implemented in the subclass")}static get deselect_event(){throw new Error("Static property deselect_event must be implemented in the subclass")}}class L{constructor(t,e,n={x:0,y:0},o={x:0,y:0},s=1,i="grabbing",a="grab"){this.element=t,this.onMoveHandler=e,this.zoomGetter="function"==typeof s?s:()=>s,this.isDragging=!1,this.dragStartPosition=o,this.initialPosition=n,this.elementX=this.initialPosition.x,this.elementY=this.initialPosition.y,this.rafId=null,this.onMoveCursor=i,this.onReleaseCursor=a,this.MOUSE_RIGHT_CLICK=2}destroy(){this.element.removeEventListener("mousedown",this.onHold.bind(this)),window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))}registerDragEvent(){this.element.addEventListener("mousedown",this.onHold.bind(this))}onHold(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!0,this.dragStartPosition={x:t.clientX,y:t.clientY},this.initialPosition={x:this.elementX,y:this.elementY},this.element.style.cursor=this.onMoveCursor,window.addEventListener("mousemove",this.onMove.bind(this)),window.addEventListener("mouseup",this.onRelease.bind(this)),this.startRaf()):console.debug("FLOW: Ignoreing Right click on ",this.element)}onMove(t){if(t.button===this.MOUSE_RIGHT_CLICK)return void console.debug("FLOW: Ignoreing Right click on",this.element);if(t.stopPropagation(),!this.isDragging)return;const e=this.zoomGetter(),n=(t.clientX-this.dragStartPosition.x)/e,o=(t.clientY-this.dragStartPosition.y)/e;this.elementX=this.initialPosition.x+n,this.elementY=this.initialPosition.y+o}onRelease(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!1,this.element.style.cursor=this.onReleaseCursor,window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))):console.debug("FLOW: Ignoreing right click on",this.element)}static register(t,e,n=1){const o=new L(t,e,{x:0,y:0},{x:0,y:0},n);return o.registerDragEvent(),o}startRaf(){if(this.rafId)return;const t=()=>{if(!this.isDragging)return cancelAnimationFrame(this.rafId),void(this.rafId=null);this.onMoveHandler(this.elementX,this.elementY),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}}class N extends k{static type="node";constructor({type:t,component:e,options:n={}}){super({type:t,component:e,options:n}),this.node=this.component}static get removal_event(){return n}}const z=new class{constructor(){this._registry=new Map}register(t){const e=t.behavior,n=t.type;if(!e)throw new Error(`Behavior ${t.name} must define static behavior`);if(!n)throw new Error(`Behavior ${t.type} must define static type`);this._registry.has(n)||this._registry.set(n,new Map),this._registry.get(n).set(e,t)}get(t,e){return this._registry.get(t)?.get(e)}getAll(t){return Array.from(this._registry.get(t)?.values()||[])}};let _=new class{constructor(){this.paths=new Map}register(t,e){this.paths.set(t,e)}get(t){return this.paths.get(t)}has(t){return this.paths.has(t)}};_.register("line",({p1:t,p2:e,options:n={}})=>`M ${t.x} ${t.y} L ${e.x} ${e.y}`),_.register("bezier",({p1:t,p2:e,options:n={}})=>{const o=n.curvature??.7,s=t.x+Math.abs(e.x-t.x)*o,i=e.x-Math.abs(e.x-t.x)*o;return`M ${t.x} ${t.y}\n            C ${s} ${t.y} ${i} ${e.y} ${e.x} ${e.y}`}),_.register("orthogonal",({p1:t,p2:e,sourceBounds:n,targetBounds:o,sourceDir:s="right",targetDir:i="left",options:a={}})=>{const r=o?.height||50,h="vertical"===a.direction,l=a.clearance??60,d=t.x+l,c=t.y+l,p=h?e.y>c+40:e.y+1>t.y,m=h?e.x+1>t.x:e.x>d+40,u=[`M ${t.x} ${t.y}`];u.push(`L ${d} ${t.y}`);let g=Math.abs(e.y-t.y),v=Math.abs(t.x-e.x);if(p)if(m)u.push(`v ${g}`),u.push("h "+(v-l));else{let t=.9*(g-r),n=g-t,o=Math.abs(d+40-e.x);u.push(`v ${t}`),u.push("h "+-1*o),u.push(`v ${n}`),u.push(`L ${e.x} ${e.y}`)}else if(m)u.push("v "+-1*g),u.push("h "+(v-l));else{let t=.9*(g-r),n=g-t,o=Math.abs(d+40-e.x);u.push("v "+-1*t),u.push("h "+-1*o),u.push("v "+-1*n),u.push(`L ${e.x} ${e.y}`)}return u.join(" ")});class T{constructor({name:t}){if(new.target===T)throw new TypeError("Cannot construct Component instances directly");this.name=t,this.containerID=this.name?this.name.toLowerCase().replace(/\s+/g,"-"):`tab-${Math.random().toString(36).substring(2,15)}`,this.id=this.containerID,this.container=null,this.created=!1,this.rendered=!1,this.parentContainer=null,this.onlyChild=null}renderInto(t,e=!1){let n;if(this.onlyChild=e,this.isRendered())console.warn(`'${this.name}' component is already rendered.`);else{if("string"==typeof t){if(n=document.getElementById(t),!n)throw new Error(`Container with id ${t} not found`)}else{if(!(t instanceof HTMLElement))throw new Error("Container must be a valid HTMLElement or a string ID.");n=t}if(!n.id)throw new Error("Container must have a valid id.");this.parentContainer=n,this.createContainer(),this.onlyChild?this.parentContainer.replaceChildren(this.container):this.parentContainer.appendChild(this.container),console.log("DOM is rendered into container ",n.id),this.rendered=!0}}getParentContainer(){return this.rendered?this.parentContainer:(console.warn(`'${this.name}' component is not rendered yet.`),null)}createContainer(){return this.isCreated()?this.container?this.container:void console.warn(`${this.component} component is already rendered.`):(this.container=this.#t(),this.initContainer(),this.container)}getContainer(){return this.container||this.createContainer(),this.container}#t(){const t=document.createElement("div");t.id=this.containerID,t.style.height="100%",t.style.width="100%";const e=this.html();return t.insertAdjacentHTML("beforeend",e),t}initContainer(){this.init(),this.created=!0}isCreated(){return this.created}isRendered(){return this.rendered}init(){throw new Error("Method 'init()' must be implemented in the subclass")}html(){throw new Error("Method '#html()' must be implemented in the subclass")}}class A extends T{constructor({name:t}){super({name:t}),this.events={}}on(t,e){(this.events[t]||=[]).push(e)}emit(t,e){(this.events[t]||[]).forEach(t=>t(e))}off(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(t=>t!==e))}clear(t){t?delete this.events[t]:this.events={}}}class D extends A{constructor({name:t,options:e={}}){super({name:t}),this.options=e,this.zoom=e.zoom||1,this.enableZoomActions=e.enable_zoom_actions||!0,this.originalZoom=this.zoom,this.canvasX=e.canvas?.x||0,this.canvasY=e.canvas?.y||0,this.canvasId=this.id+"-canvas",this.containerId=this.id+"-flow-container",this.zoomActionsId=this.id+"-zoom-actions",this.arrowMarkerSize=e.arrow_marker_size||7}html(){return`\n            <div id="${this.canvasId}" \n                class="flow-canvas" \n                style="transform: translate(${this.canvasX}px, ${this.canvasY}px) scale(${this.zoom})">\n                <svg id="${this.id}-svg" class="flow-connections"></svg>\n            </div>\n            ${this.enableZoomActions?`<div id="${this.zoomActionsId}" class="zoom-actions"></div>`:""}\n        `}init(){this.containerEl=this.parentContainer,this.canvasEl=this.container.querySelector(`#${this.canvasId}`),this.svgEl=this.container.querySelector(`#${this.id}-svg`),this.container=this.canvasEl,L.register(this.containerEl,this.redrawCanvasWithXY.bind(this)),this.enableZoomActions&&this.containerEl.addEventListener("wheel",this.onCanvasWheelZoom.bind(this),{passive:!1}),this.containerEl.addEventListener("dragover",t=>t.preventDefault()),this.containerEl.addEventListener("drop",this.onDrop.bind(this)),function(t,e=5){if(t.querySelector("#arrow-end"))return;const n=document.createElementNS("http://www.w3.org/2000/svg","defs"),o=(t,n)=>{const o=document.createElementNS("http://www.w3.org/2000/svg","marker");o.setAttribute("id",t),o.setAttribute("markerWidth",e),o.setAttribute("markerHeight",e),o.setAttribute("refX",e),o.setAttribute("refY",e/2),o.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",n),s.setAttribute("fill","context-stroke"),o.appendChild(s),o};n.appendChild(o("arrow-end",`M 0 0 L ${e} ${e/2} L 0 ${e} Z`)),n.appendChild(o("arrow-start",`M ${e} 0 L 0 ${e/2} L ${e} ${e} Z`)),t.appendChild(n)}(this.svgEl,this.arrowMarkerSize)}redrawCanvas(){this.redrawCanvasWithXY(this.canvasX,this.canvasY)}redrawCanvasWithXY(t,e){this.canvasX=t,this.canvasY=e,this.canvasEl.style.transform=`translate(${t}px, ${e}px) scale(${this.zoom})`;const n=this.gridFactor*this.zoom;this.containerEl.style.backgroundSize=`${n}px ${n}px`,this.containerEl.style.backgroundPosition=`${t}px ${e}px`}onCanvasWheelZoom(t){t.preventDefault(),console.log("FLOW: Wheel on canvas with deltaY: ",t.deltaY);const n=t.deltaY>0?-.1:.1,o=Math.max(.1,Math.min(this.zoom+n,3));this.zoom=o,this.redrawCanvas(),this.emit(e,{data:{zoom:this.zoom,x:this.canvasX,y:this.canvasY,delta:n,originalZoom:this.originalZoom}})}onDrop(t){t.preventDefault(),t.stopPropagation();try{const e=t.dataTransfer.getData("module"),n=t.dataTransfer.getData("group"),o=t.dataTransfer.getData("name"),s=t.dataTransfer.getData("label"),i=t.dataTransfer.getData("data");if(!e||!n||!o)return;let r;try{r=i?JSON.parse(i):{}}catch(t){console.error("Invalid drop data",t),r={}}const h=this.containerEl.getBoundingClientRect(),l=t.clientX-h.left-this.canvasX,d=t.clientY-h.top-this.canvasY;this.emit(a,{module:e,group:n,name:o,label:s,x:l,y:d,data:r}),console.debug("FLOW - DROP: ",e,n,o,s,l,d,r)}catch(t){console.error("Invalid drop data",t)}}}class R extends A{constructor({model:t,view:e,behaviors:n=new Set}){super({name:`node-${t.id}`}),this.id=t.id,this.name=t.name,this.model=t,this.view=e,this.behaviors=n,this.destroyed=!1}html(){return""}setBehaviors(t){this.behaviors=t}addBehavior(t){this.behaviors.add(t)}removeBehavior(t){this.behaviors.delete(t)}renderInto(t){this.view.renderInto(t)}init(){this.behaviors.forEach(t=>{try{t._attach()}catch(e){console.error("Failed to attach behavior",t,e)}})}move(t,e){this.model.move(t,e),this.view.move(),this.emit(o,{id:this.id,x:t,y:e})}onResize(t,e){const{x:n,y:o}=this.model;this.model.resize(t,e),this.view.resizeNode(),this.emit(r,{id:this.id,x:n,y:o,w:t,h:e})}destroy(){this.behaviors.forEach(t=>t.detach?.()),this.behaviors.clear(),this.view.destroy(),this.view=null,this.behaviors=null,this.model=null,this.destroyed=!0}isCapabilitySupported(t){return this.model.capabilities.includes(t)}get x(){return this.model.x}get y(){return this.model.y}get w(){return this.model.w}get h(){return this.model.h}select(){this.view.setSelected(!0),this.emit(s,{id:this.model.id})}deselect(){this.view.setSelected(!1),this.emit(i,{id:this.model.id})}}const B=[w,b];class O{constructor({id:t,name:e,label:n,module:o="default",group:s="default",inputs:i=1,outputs:a=1,x:r=0,y:h=0,h:l=100,w:d=200,data:c={},capabilities:p=B}){this.id=t,this.module=o,this.group=s,this.name=e,this.inputs=i,this.outputs=a,this.x=r,this.y=h,this.h=l,this.w=d,this.data=c,this.capabilities=p,this.label=n??this.name}move(t,e){this.x=t,this.y=e}resize(t,e){this.w=t,this.h=e}}class W{constructor({registry:t}){this.registry=t}resolve(t,e,n={}){const o=new Set;return e.model.capabilities?.forEach(s=>{const i=this.registry.get(t,s);if(i){const s=new i({type:t,component:e,options:n});console.log("behaviorInstance",s),o.add(s)}}),o}}const j=new class{constructor(){this.views=new Map}register(t){const e=t.modelDefaults;this.views.set(e.module+":"+e.group+":"+e.name,t)}get(t,e,n){return this.views.get(t+":"+e+":"+n)}};class H extends A{constructor(t,e={}){if(!(t instanceof O))throw new Error("Model must be an instance of NodeModel");super({name:`node-${t.id}`}),this.model=t,this.options=e,this.el=null,this.contentId=`content-${t.id}`,this.zoomGetter=e.zoomGetter||(()=>this.options.zoom??1),this._content=null,this.close=null}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:70,label:"Node",group:"default",module:"default",capabilities:x,data:{}}}html(){return this._content=this.getNodeElement(),"string"==typeof this._content?this._content:""}init(){this.el=this.container,this.updateContainerAttributes(),this._content&&("string"==typeof this._content?this.el.innerHTML=this._content:this.el.appendChild(this._content)),this.createAllPorts(),this._bindEvents(),this.bindEvents()}updateContainerAttributes(){this.container.dataset.id="node-"+this.model.id,this.container.dataset.name=this.model.name,this.container.dataset.module=this.model.module,this.container.dataset.group=this.model.group,this.container.style.top=`${this.model.y}px`,this.container.style.left=`${this.model.x}px`,this.container.style.width=`${this.model.w}px`,this.container.style.height=`${this.model.h}px`,this.container.style.position="absolute",this.container.classList.add("flow-node")}createAllPorts(){const t=this.createPorts({type:"input",count:this.model.inputs}),e=this.createPorts({type:"output",count:this.model.outputs}),n=this.createClose();this.close=n,this.el.prepend(t),this.el.appendChild(e),this.el.appendChild(n)}destroy(){this.el?.remove(),this.el=null}propagateEvent(t,e){e.on(t,e=>this.emit(t,e))}querySelector(t){return this.el.querySelector(t)}setSelected(t){this.el.classList.toggle("selected",t)}move(){this.el.style.top=`${this.model.y}px`,this.el.style.left=`${this.model.x}px`}getPortPosition({type:t,index:e}){if(!this.el)return null;const n=this.el.querySelector(`.flow-port[data-type="${t}"][data-index="${e}"]`);if(!n)return null;const o=this.el.getBoundingClientRect(),s=n.getBoundingClientRect(),i="function"==typeof this.zoomGetter?this.zoomGetter():1,a=(s.left-o.left+s.width/2)/i,r=(s.top-o.top+s.height/2)/i;return{x:this.model.x+a,y:this.model.y+r}}getBounds(){const t=this.el;return{left:t.offsetLeft,top:t.offsetTop,right:t.offsetLeft+t.offsetWidth,bottom:t.offsetTop+t.offsetHeight,width:t.offsetWidth,height:t.offsetHeight}}createPorts({type:t,count:e}){const n=document.createElement("div");n.className=`flow-ports-column flow-ports-${t}`;for(let o=0;o<e;o++){const e=document.createElement("div");e.className="flow-port",e.dataset.type=t,e.dataset.index=o,e.dataset.nodeId=this.model.id,n.appendChild(e)}return n}createClose(){const t=document.createElement("button");return t.className="btn-danger btn-close node-close border rounded shadow-none m-1",t.dataset.nodeId=this.model.id,t.setAttribute("aria-label","Close"),t}_bindEvents(){console.debug("FLOW: Bind events",this.name),this.bindMouseDown(),this.bindRemoveNode(),this.bindOutputPorts(),this.bindInputPorts()}bindRemoveNode(){this.el.querySelector(".node-close")?.addEventListener("click",t=>{t.stopPropagation(),this.emit(n,{id:this.model.id})})}bindMouseDown(){this.el.addEventListener("mousedown",t=>{this.emit("node:pointer:down",{event:t})})}bindInputPorts(){this.el.querySelectorAll(".flow-ports-input .flow-port").forEach(t=>{t.addEventListener("mouseup",e=>{console.debug("FLOW: Port connect end",e),this.emit(d,{nodeId:this.model.id,portIndex:t.dataset.index,event:e})})})}bindOutputPorts(){this.el.querySelectorAll(".flow-ports-output .flow-port").forEach(t=>{t.addEventListener("mousedown",e=>{console.debug("FLOW: Port connect start",e),this.emit(l,{nodeId:this.model.id,portIndex:t.dataset.index,event:e})})})}resizeNode(){this.el.style.width=`${this.model.w}px`,this.el.style.height=`${this.model.h}px`,this.resize?.()}attachEvent(t,e){this.el.addEventListener(t,e)}detachEvent(t,e){this.el.removeEventListener(t,e)}getNodeElement(){}bindEvents(){}}class G extends H{constructor(t,e={}){super(t,e)}static get name(){return"default-node-view"}getNodeElement(){return`\n        <div class="node" style="display: grid; place-items: center;">\n            <div class="node-label">${this.model.label}</div>\n        </div>\n    `}}class F extends A{constructor({name:t,canvasContainer:e,zoomGetter:n=()=>1,View:o=G,viewRegistry:s=j,behaviorRegistry:i=z,BehaviorResolverCls:a=W}){super({name:t+"node-manager"}),this.canvasContainer=e,this.zoomGetter=n,this.View=o,this.viewRegistry=s,this.nodes=new Map,this.idCounter=1,this.behaviorRegistry=i,this.BehaviorResolverCls=a,this.behaviorResolver=new this.BehaviorResolverCls({registry:this.behaviorRegistry}),this.behaviors=[],this.type="node"}dropNode(t){console.debug("FLOW: Drop node",t),this.addNode(t,!0)}addNode(t,e=!1){console.debug("FLOW: Add node",t);let n=this.viewRegistry.get(t.module,t.group,t.name);n||(console.warn("No nodeview fond for {",t.module,t.group,t.name,"}. Using default view."),n=this.View);const o=n.modelDefaults;if(e){const e=this.zoomGetter(),n=t.h??o.h??100,s=t.w??o.w??200,i=(t.x-s/2)/e,a=(t.y-n/2)/e;t.x=i,t.y=a}Object.keys(o).forEach(e=>{const n=t[e];void 0!==n&&"undefined"!==n||(t[e]=o[e])});const s=this.#e(t,n);return s.renderInto(this.canvasContainer),s.init(),this.nodes.set(s.id,s),s.id}#e(t,e){const a=this.idCounter++,c=new O({id:a,...t}),p=new e(c,{...this.options,zoomGetter:this.zoomGetter}),m=new R({model:c,view:p}),u=this.behaviorResolver.resolve(this.type,m,this.options);return m.setBehaviors(u),this.propagateEvent(l,p),this.propagateEvent(d,p),this.propagateEvent(s,p),this.propagateEvent(i,p),this.propagateEvent(o,m),this.propagateEvent(r,m),this.propagateEvent(h,m),p.on(n,t=>this.removeNode(t.id)),m}removeNode(t){let e=this.getNode(t);e&&(e.destroy(),this.nodes.delete(t),this.emit(n,{id:t}),e=null)}propagateEvent(t,e){e.on(t,e=>this.emit(t,e))}reset(){Object.values(this.nodes).forEach(t=>{t.destroy()}),this.nodes.clear(),this.idCounter=1}getNode(t){return this.nodes.get(t)}getAllNodes(){return[...this.nodes.values()]}get size(){return this.nodes.size}}class Y{constructor(t,e={}){this.stroke=e.stroke??void 0,this.width=e.width??2,this.dash=e.dash??null,this.animated=!!e.animated,this.path=t??v,_.has(this.path)||(console.warn(`Path ${this.path} not found. setting to default path type ${v}.`),this.path=v),this.arrows={start:e.arrows?.start??!1,end:e.arrows?.end??!0},this.bad=!1,this.hover=!1,this.selected=!1,this.temp=!1,this.execution=e.execution??!1,this.speed=e.execution_speed??2}markBad(t=!0){this.bad=t}markHover(t=!0){this.hover=t}markSelected(t=!0){this.selected=t}markTemp(t=!0){this.temp=t}markExecution(t=!0){this.execution=t}applyTo(t){this.stroke&&(t.style.stroke=this.stroke),t.style.strokeWidth=this.width,t.style.strokeDasharray=this.dash??"",t.classList.toggle("animated",this.animated),t.classList.toggle("flow-connection-temp",this.temp),t.classList.toggle("flow-connection-path-bad",this.bad),t.classList.toggle("selected",this.selected),t.classList.toggle("path-hover",this.hover),this.execution?(t.style.strokeDasharray="6 4",t.style.animation=`flow ${1/this.speed}s linear infinite`):(t.style.strokeDasharray=this.dash??"",t.style.animation="")}}const X=[w];class q extends A{constructor({id:t,outNodeId:e,outPort:n,inNodeId:o,inPort:s,capabilities:i=X,options:a={}}){super({name:`connection-${t}`}),this.id=t,this.outNodeId=e,this.outPort=n,this.inNodeId=o,this.inPort=s,this.options=a,this.style={width:2,dash:null,animated:!1,...a.style},this.style=new Y(this.pathType,this.style),this.capabilities=i}get source(){return{nodeId:this.outNodeId,portIndex:this.outPort}}get target(){return{nodeId:this.inNodeId,portIndex:this.inPort}}get arrows(){return this.style.arrows}get pathType(){return this.options.pathType??v}}class Z extends A{#n=null;#o=null;constructor({model:t,nodeManager:e,options:n={}}){super({name:`connection-view-${t.id}`}),this.model=t,this.nodeManager=e,this.path=null,this.shadowPath=null,this.options=n,this.container=null,this.#n=null,this.#o=null,this.adjustEnd=!1,this.adjustStart=!1,this.adjustOffset=6,this.endMarker=!0,this.startMarker=!0,this.isTemp=n.isTemp??!1}html(){return""}init(){this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.path.classList.add("flow-connection-path","connection"),this.path.setAttribute("id",this.model.id),this.parentContainer.appendChild(this.path),this.container=this.path,this.initShadowPath(),this.applyArrows(),this.el=this.path}static getConnectionKey(t,e,n,o){return`${t}:${e}-${n}:${o}`}applyArrows(){const t=this.model.arrows||{};this.endMarker=t.end??this.endMarker,this.startMarker=t.start??this.startMarker,this.path.removeAttribute("marker-start"),this.path.removeAttribute("marker-end"),this.startMarker&&(this.adjustStart=!0,this.path.setAttribute("marker-start","url(#arrow-start)")),this.endMarker&&(this.adjustEnd=!0,this.path.setAttribute("marker-end","url(#arrow-end)"))}initShadowPath(){this.shadowPath=document.createElementNS("http://www.w3.org/2000/svg","path"),this.shadowPath.classList.add("flow-connection-path","shadow-path"),this.shadowPath.setAttribute("id","shadow-"+this.model.id),this.shadowPath.style.stroke="transparent",this.shadowPath.style.strokeWidth=18,this.shadowPath.style.fill="none",this.shadowPath.style.pointerEvents=this.isTemp?"none":"stroke",this.parentContainer.appendChild(this.shadowPath)}applyStyle(){this.model.style.applyTo(this.path)}#s(t,e){let n=t,o=e;return this.adjustEnd&&(o={x:e.x-this.adjustOffset,y:e.y}),this.adjustStart&&(n={x:t.x+this.adjustOffset+16,y:t.y}),{p1:n,p2:o}}update(t,e,n={}){if(!t||!e)return;const o=t.view.getPortPosition({type:"output",index:this.model.source.portIndex}),s=e.view.getPortPosition({type:"input",index:this.model.target.portIndex});o&&s&&this.#i(o,s,n)}updateTempPath(t,e,n={}){this.model.style.markTemp(!0),this.path.style.pointerEvents="none",this.#i(t,e,n)}#i(t,e,n={}){const o=this.#s(t,e);this.updatePath(o.p1,o.p2,n)}updatePath(t,e,n={}){const o=this.model.style.path??"bezier";this.#n=t??this.#n,this.#o=e??this.#o;const s=_.get(o)({p1:this.#n,p2:this.#o,...n,zoom:this.options.zoom});this.shadowPath.setAttribute("d",s),this.path.setAttribute("d",s),this.path.setAttribute("p1x",t.x),this.path.setAttribute("p1y",t.y),this.path.setAttribute("p2x",e.x),this.path.setAttribute("p2y",e.y),this.applyStyle(),this.applyArrows()}addStyleClass(t){this.path.classList.add(t)}removeStyleClass(t){this.path.classList.remove(t)}destroy(){this.path?.remove(),this.shadowPath?.remove(),this.path=null,this.shadowPath=null}bindEvents(){this.bindSelect(),this.bindShadowSelect()}bindSelect(){this.path.addEventListener("click",t=>{t.stopPropagation(),this.emit(m,this.model.id)})}bindShadowSelect(){this.shadowPath.addEventListener("mouseover",t=>{t.stopPropagation(),this.model.style.markHover(!0),this.applyStyle()}),this.shadowPath.addEventListener("mouseout",t=>{t.stopPropagation(),this.model.style.markHover(!1),this.applyStyle()})}setSelected(t){console.log("setSelected",t),this.model.style.markSelected(t),this.applyStyle()}attachEvent(t,e){this.path.addEventListener(t,e),this.shadowPath.addEventListener(t,e)}detachEvent(t,e){this.path.removeEventListener(t,e),this.shadowPath.removeEventListener(t,e)}}class U extends A{constructor({model:t,view:e,nodeManager:n,behaviors:o=new Set}){super({name:`connection-${t.id}`}),this.model=t,this.view=e,this.nodeManager=n,this.destroyed=!1,this._source=null,this._target=null,this.behaviors=o,this.id=this.model.id}get outNodeId(){return this.model.outNodeId}get inNodeId(){return this.model.inNodeId}get inPort(){return this.model.inPort}get outPort(){return this.model.outPort}get source(){return this._source||(this._source={nodeId:this.model.source.nodeId,portIndex:this.model.source.portIndex}),this._source}get target(){return this._target||(this._target={nodeId:this.model.target.nodeId,portIndex:this.model.target.portIndex}),this._target}renderInto(t){this.view.renderInto(t),this.init()}init(){this.update(),this.attachBehaviors(),console.log("Connection init",this.behaviors)}update(){const t=this.nodeManager.getNode(this.model.source.nodeId),e=this.nodeManager.getNode(this.model.target.nodeId),n={sourceBounds:t.view.getBounds(),targetBounds:e?.view.getBounds()};this.view.update(t,e,n)}updateWithXY(t,e){const n=this.nodeManager.getNode(this.source.nodeId);if(!n)return;const o=n.view.getPortPosition({type:"output",index:this.source.portIndex}),s={x:t,y:e},i={sourceBounds:n.view.getBounds()};this.view.updateTempPath(o,s,i)}markBadPath(){this.model.style.markBad(!0),this.view.applyStyle()}destroy(){this.view.destroy(),this.view=null,this.model=null,this.nodeManager=null,this.destroyed=!0}clearBadPath(){this.model.style.markBad(!1),this.view.applyStyle()}setPathStyle(t){this.model.pathType=t,this.view.updatePath()}select(){this.view.setSelected(!0),this.emit(u,{id:this.model.id})}deselect(){this.view.setSelected(!1),this.emit(g,{id:this.model.id})}setBehaviors(t){this.behaviors=t}addBehavior(t){this.behaviors.add(t)}removeBehavior(t){this.behaviors.delete(t)}attachBehaviors(){this.behaviors.forEach(t=>{try{t._attach()}catch(e){console.error("Failed to attach behavior",t,e)}})}isCapabilitySupported(t){return this.model.capabilities.includes(t)}}class K extends A{constructor({name:t,connectionContainer:e,nodeManager:n,behaviorRegistry:o=z,BehaviorResolverCls:s=W,options:i={}}){super({name:t+"-flow-connection-manager",options:i}),this.connectionContainer=e,this.nodeManager=n,this.options=i,this.zoom=i.zoom||1,this.originalZoom=this.zoom,this.nodeIdCounter=1,this.nodeWidth=i.nodeWidth||200,this.nodeHeight=i.nodeHeight||90,this.connections=new Map,this.tempConnection=null,this.badConnections=new Set,this.behaviorRegistry=o,this.BehaviorResolverCls=s,this.behaviorResolver=new this.BehaviorResolverCls({registry:this.behaviorRegistry}),this.type="connection"}addConnection(t,e,n,o,s=void 0){const i=Z.getConnectionKey(t,e,n,o),a=this.#a({id:i,outNodeId:t,outPort:e,inNodeId:n,inPort:o,pathType:s,isTemp:!1});return this.connections.set(i,a),a}beginTempConnection(t,e,n=void 0){const o=this.#a({id:"temp",outNodeId:t,outPort:e,inNodeId:null,inPort:null,pathType:n,isTemp:!0});return this.tempConnection=o,o}#a({id:t,outNodeId:e,outPort:n,inNodeId:o,inPort:s,pathType:i,isTemp:a=!1}){const r=i??this.options?.connection?.path_type??v,h={...this.options?.connection,pathType:r},l=new q({id:t,outNodeId:e,outPort:n,inNodeId:o,inPort:s,options:h}),d=new Z({model:l,options:{...h,isTemp:a}}),c=new U({model:l,view:d,nodeManager:this.nodeManager,options:h}),p=this.behaviorResolver.resolve(this.type,c,this.options);return c.setBehaviors(p),c.renderInto(this.connectionContainer.id),d.on(m,t=>{this.removeConnection(t)}),c}reset(){this.connections.forEach(t=>t.destroy()),this.connections.clear(),this.clearTempPath?.()}updateConnections(t){const e=parseInt(t);this.connections.forEach((t,n)=>{t.source.nodeId!==e&&t.target.nodeId!==e||(t.update(),this.emit("connection:updated",t))})}updateTempConnection(t,e){this.tempConnection&&(this.clearBadPaths(),this.tempConnection.updateWithXY(t,e))}removeConnection(t){const e=this.getConnection(t);this.emit(p,t),this.connections.delete(t),e?.destroy()}removeRelatedConnections(t){this.connections.forEach((e,n)=>{e.source.nodeId!==t&&e.target.nodeId!==t||this.removeConnection(n)})}endTempConnection(){this.clearTempPath(),this.tempConnection=null}clearTempPath(){this.clearBadPaths(),this.tempConnection&&(this.tempConnection.destroy(),this.tempConnection=null)}markTempPathBad(){this.tempConnection&&this.markPathBad(this.tempConnection)}markPathBad(t){t.markBadPath(),this.badConnections.add(t)}clearBadPaths(){this.badConnections.forEach(t=>{t.clearBadPath()}),this.badConnections.clear()}getZoom(){return this.zoom}getAllConnections(){return[...this.connections.values()]}getConnection(t){return this.connections.get(t)}get size(){return this.connections.size}}class V{export(t){const e=t.nodeManager,n=t.connectionManager,o=t.canvas,s=[];e.getAllNodes().forEach(t=>{s.push(t.model)});const i=[];return n.getAllConnections().forEach(t=>{i.push(t.model)}),{nodes:s,connections:i,zoom:o.zoom,canvas:{x:o.canvasX,y:o.canvasY}}}import(t,e){const{nodeManager:n,connectionManager:o,canvas:s}=t,i=e.zoom||1;t.zoom=i,s.zoom=i,n.zoom=i,o.zoom=i,s.canvasX=e.canvas?.x||0,s.canvasY=e.canvas?.y||0,s.redrawCanvas(),n.reset?.(),o.reset?.(),e.nodes&&e.nodes.forEach(t=>{n.addNode(t)}),e.connections&&e.connections.forEach(e=>{t.addConnection(e.outNodeId,e.outPort,e.inNodeId,e.inPort)})}}class J{onConnectionAttempt({outNodeId:t,inNodeId:e}){return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:e}){}onConnectionRemoved({outNodeId:t,inNodeId:e}){}}class Q{constructor(t=document.documentElement){this.root=t,this.root.hasAttribute("data-floxy-grid-type")||this.root.setAttribute("data-floxy-grid-type","dots");const e=localStorage.getItem("floxy-theme")||"system";this.setGlobalTheme(e)}getGlobalTheme(){return this.root.getAttribute("data-floxy-theme")||"light"}setGlobalTheme(t){let e=t;"system"===t&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),this.root.setAttribute("data-floxy-theme",e),localStorage.setItem("floxy-theme",t)}setToken(t,e){this.root.style.setProperty(`--floxy-${t}`,e),"grid-type"===t&&this.root.setAttribute("data-floxy-grid-type",e)}setTheme(t){Object.entries(t).forEach(([t,e])=>{this.setToken(t,e)})}getToken(t){return"global-theme"===t?localStorage.getItem("floxy-theme")||"system":getComputedStyle(this.root).getPropertyValue(`--floxy-${t}`).trim()}}class tt extends H{constructor(t,e={}){super(t,e),this.shapeName="svg",this.shape=null,this.label=null}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:150,label:"SVG",module:"default",group:"default",name:"svg",capabilities:x,data:{}}}getNodeElement(){const t=document.createElement("div");t.className=`flow-node ${this.shapeName}-node`;const e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.classList.add("node"),this.shape=this.createShape(),this.label=this.createLabel(),this.shape.classList.add("shape"),e.appendChild(this.shape),t.appendChild(e),t.appendChild(this.label),t}init(){super.init(),this.resize()}createLabel(){const t=document.createElement("div");return t.classList.add("node-label"),t.setAttribute("contenteditable",!1),t.textContent=this.model.label,t}createShape(){if(!E.includes(this.shapeName))throw new Error(`Can not create give ${this.shapeName} svg shape`);return document.createElementNS("http://www.w3.org/2000/svg",this.shapeName)}resize(){throw new Error("Method 'resize()' must be implemented in the subclass")}}const et=[b,f,C,w];return z.register(class extends N{static get behavior(){return b}gaurd(){return"function"==typeof this.node.view.move||(console.warn("Node view does not have move method to support draggable behavior"),!1)}attach(){const t=this.node.view;this.dragHandler=new L(t.el,(t,e)=>{this.node.move(t,e)},{x:this.node.x,y:this.node.y},{x:0,y:0},t.zoomGetter),this.dragHandler.registerDragEvent()}detach(){this.dragHandler?.destroy()}}),z.register(class extends M{static type="node";constructor({type:t,component:e,options:n={}}){super({type:t,component:e,options:n}),this.node=this.component}static get behavior(){return y}static get removal_event(){return n}static get select_event(){return s}static get deselect_event(){return i}}),z.register(class extends N{static get behavior(){return f}gaurd(){const t=this.node.view.el.querySelector(".node-label");return t?(this._el=t,!0):(console.warn("Node view does not have label element to support editable label behavior"),!1)}attach(){if(!this._el)return;this._onDblClick=(t=>{t.stopPropagation(),this._el.contentEditable="true",this._el.focus(),document.execCommand("selectAll",!1,null)}).bind(this),this._onBlur=(()=>{this._el.contentEditable="false",this.node.model.label=this._el.textContent.trim(),this.node.emit(h,{id:this.node.id,label:this.node.model.label})}).bind(this),this._onKeyDown=(t=>{"Enter"===t.key&&(t.preventDefault(),this._el.blur())}).bind(this),this._el.addEventListener("dblclick",this._onDblClick),this._el.addEventListener("blur",this._onBlur),this._el.addEventListener("keydown",this._onKeyDown)}detach(){this._el&&(this._el.removeEventListener("dblclick",this._onDblClick),this._el.removeEventListener("blur",this._onBlur),this._el.removeEventListener("keydown",this._onKeyDown),this._el=null)}}),z.register(class extends N{static get behavior(){return C}attach(){const t=this.node.view.el,e=this.node.view;this.handle=document.createElement("div"),this.handle.className="resize-handle resize-br",t.appendChild(this.handle),this.dragHandler=new L(this.handle,(t,e)=>{const n=Math.max(150,t-this.node.x),o=Math.max(50,e-this.node.y);this.node.onResize(n,o)},{x:this.node.x+this.node.w,y:this.node.y+this.node.h},{x:0,y:0},e.zoomGetter,"nwse-resize","nwse-resize"),this.dragHandler.registerDragEvent()}detach(){this.handle?.remove(),this.dragHandler?.destroy()}}),z.register(class extends M{static type="connection";constructor({type:t,component:e,options:n={}}){super({type:t,component:e,options:n}),this.connection=this.component}static get behavior(){return y}static get removal_event(){return p}static get select_event(){return u}static get deselect_event(){return g}}),j.register(class extends tt{constructor(t,e={}){super(t,e),this.shapeName="ellipse",this.ellipse=null}static get modelDefaults(){return{inputs:1,outputs:1,w:250,h:150,label:"Action",module:"diagram",group:"workflow",name:"action",capabilities:et,data:{}}}createShape(){const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return this.ellipse=t,this.ellipse}updateShape(){}resize(){const{w:t,h:e}=this.model,n=(t-1)/2,o=(e-1)/2;this.ellipse.setAttribute("cx",n),this.ellipse.setAttribute("cy",o),this.ellipse.setAttribute("rx",n),this.ellipse.setAttribute("ry",o)}}),t.DagValidator=class extends J{constructor({enabled:t=!0}={}){super(),this.enabled=t,this.adjacencyList={},this.nonCyclicCache={},this.tempCyclicCache={},this.tempStackCache={}}onConnectionAttempt({outNodeId:t,inNodeId:e}){const n="This connection will create cyclic flow.";if(!this.enabled)return{valid:!0};const o=`${t}->${e}`;if(void 0!==this.nonCyclicCache[o])return{valid:!this.nonCyclicCache[o]};if(this.tempCyclicCache[o])return{valid:!1,stack:this.tempStackCache[o],message:n};this.tempStackCache[o]=[];const s=this.tempStackCache[o],i=new Set;let a=new Set(this.adjacencyList[t]||new Set);a.add(e),i.add(t),s.push(t);for(const t of a)if(this.#r(t,i,s))return this.tempCyclicCache[o]=!0,{valid:!1,stack:s,message:n};return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:e}){this.#h(t,e),this.#l(t,e)}onConnectionRemoved({outNodeId:t,inNodeId:e}){const n=`${t}->${e}`;this.adjacencyList[t]?.delete(e),delete this.nonCyclicCache[n],this.tempCyclicCache={}}#h(t,e){this.adjacencyList[t]||(this.adjacencyList[t]=new Set),this.adjacencyList[t].add(e)}#l(t,e){const n=`${t}->${e}`;this.nonCyclicCache[n]=!1,delete this.tempStackCache[n]}#r(t,e,n){if(n.includes(t))return n.push(t),!0;if(e.has(t))return!1;e.add(t),n.push(t);for(const o of this.adjacencyList[t]||[])if(this.#r(o,e,n))return!0;return n.pop(),!1}},t.Flow=class extends A{constructor({name:t,options:e={},validators:n=[],notification:o=null}){super({name:t}),this.options=e,this.validators=n,this.notification=o,this.serializer=new V,this.zoom=e.zoom||1,this.originalZoom=this.zoom,this.nodes={},this.nodeIdCounter=1,this.canvasEl=null,this.svgEl=null,this.nodeManager=null,this.connectionManager=null,this.rafId=null,this.isConnecting=!1}html(){return""}init(){this.container.classList.add("floxy-flow-container"),this.canvas=new D({name:this.name+"-canvas",options:this.options}),this.canvas.renderInto(this.container),this.containerEl=this.container,this.canvasEl=this.canvas.canvasEl,this.svgEl=this.canvas.svgEl,this.nodeManager=new F({name:this.name+"-flow-node-manager",canvasContainer:this.canvasEl,zoomGetter:()=>this.zoom,options:this.options}),this.connectionManager=new K({name:this.name+"-flow-connection-manager",connectionContainer:this.svgEl,nodeManager:this.nodeManager,options:this.options}),this.canvas.on(e,({data:t})=>{this.zoom=t.zoom,this.connectionManager.zoom=t.zoom,this.nodeManager.zoom=t.zoom}),this.canvas.on(a,t=>{console.debug("Node is dropped: ",t),this.emit(a,t),this.nodeManager.dropNode(t)}),this.nodeManager.on(o,({id:t,x:e,y:n})=>{this.emit(o,{id:t,x:e,y:n}),this.connectionManager.updateConnections(t)}),this.nodeManager.on(r,({id:t,x:e,y:n,w:o,h:s})=>{this.emit(r,{id:t,x:e,y:n,w:o,h:s}),this.connectionManager.updateConnections(t)}),this.nodeManager.on(n,({id:t})=>{console.debug("Node is removed: ",t),this.emit(n,{id:t}),this.removeNode(t)}),this.nodeManager.on(l,({nodeId:t,portIndex:e,event:n})=>{console.debug("Port connect start: ",t,e,n),this.mouseDownStartConnection({dataset:{index:e}},t,n)}),this.nodeManager.on(d,({nodeId:t,portIndex:e,event:n})=>{console.debug("Port connect end: ",t,e,n),this.mouseUpCompleteConnection({dataset:{index:e}},t,n)}),this.connectionManager.on(c,t=>{console.debug("Connection is created: ",t),this.emit(c,t),this.validators.forEach(e=>e.onConnectionAdded?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))}),this.connectionManager.on(m,t=>{console.debug("Connection is clicked: ",t),this.emit(m,t),this.connectionManager.removeConnection(t)}),this.connectionManager.on(p,t=>{console.debug("Connection is removed: ",t),this.emit(p,t),this.validators.forEach(e=>e.onConnectionRemoved?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))})}highlightCycle(t){if(t&&!(t.length<2)){console.log("FLOW: highlight cycle",t);for(let e=0;e<t.length-1;e++){const n=this.connectionManager.getAllConnections().find(n=>n.outNodeId===t[e]&&n.inNodeId===t[e+1]);n&&this.connectionManager.markPathBad(n)}}}addNode(t){return this.nodeManager.addNode(t)}mouseDownStartConnection(t,e,n){console.debug("FLOW: Start connection from port: ",t,"nodeId: ",e),n.stopPropagation(),this.isConnecting=!0,this.connectionStart={nodeId:e,index:t.dataset.index},this.connectionManager.beginTempConnection(e,t.dataset.index),this._drawConnection=n=>this.mouseMoveDrawConnection(t,e,n),this._cancelConnection=t=>this.keyDownCancelConnection(t,e),window.addEventListener("mousemove",this._drawConnection),window.addEventListener("keydown",this._cancelConnection),this.startRaf(()=>{const t=this.connectionStart.prevX==this.connectionStart.x&&this.connectionStart.prevY==this.connectionStart.y;this.connectionStart.x&&this.connectionStart.y&&!t&&(this.connectionStart.prevX=this.connectionStart.x,this.connectionStart.prevY=this.connectionStart.y,this.connectionManager.updateTempConnection(this.connectionStart.x,this.connectionStart.y))})}mouseMoveDrawConnection(t,e,n){if(this.isConnecting){this._canvasRect||(this._canvasRect=this.canvasEl.getBoundingClientRect());const t=this._canvasRect,e=(n.clientX-t.left)/this.zoom,o=(n.clientY-t.top)/this.zoom;this.connectionManager.updateTempConnection(e,o),this.connectionStart.x=e,this.connectionStart.y=o}}mouseUpCompleteConnection(t,e,n){if(this.isConnecting){const t=n.target.closest(".flow-port");if(t&&"input"===t.dataset.type){const o=parseInt(t.dataset.nodeId),s=parseInt(t.dataset.index);this.addConnection(this.connectionStart.nodeId,this.connectionStart.index,o,s,n,e)&&this.connectionManager.endTempConnection()}}}addConnection(t,e,n,o,s=null,i=null){for(const e of this.validators){const o=e.onConnectionAttempt({outNodeId:t,inNodeId:n});if(!o.valid)return this.notification?.warning(o.message),this.connectionManager.markTempPathBad(),o.stack&&this.highlightCycle(o.stack),!1}const a=this.connectionManager.addConnection(t,e,n,o);return a&&(this.validators.forEach(e=>e.onConnectionAdded?.({outNodeId:t,inNodeId:n})),s&&this.keyDownCancelConnection(s,i)),a}keyDownCancelConnection(t,e){"keydown"==t.type&&"Escape"!==t.key&&27!==t.keyCode||(this.isConnecting=!1,this.connectionManager.endTempConnection(),this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection),this._drawConnection=null))}removeNode(t){this.connectionManager.removeRelatedConnections(t)}export(){return this.serializer.export(this)}import(t){this.serializer.import(this,t)}startRaf(t){if(this.rafId)return;const e=()=>{if(!this.isConnecting)return cancelAnimationFrame(this.rafId),this.rafId=null,void(this._canvasRect=null);t(),this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}destroy(){this.isConnecting=!1,this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection)),cancelAnimationFrame(this.rafId)}},t.ThemeEditor=class extends A{constructor(t={}){super({name:"flow-theme-editor"}),this.manager=t.manager||new Q,this.isOpen=!1,this.config=[{category:"Global Appearance",tokens:[{name:"global-theme",label:"Color Theme",type:"select",options:[{label:"Light",value:"light"},{label:"Dark",value:"dark"},{label:"System",value:"system"}]}]},{category:"Brand Colors",group:!0,tokens:[{name:"primary-color",label:"Primary",type:"color"},{name:"secondary-color",label:"Secondary",type:"color"},{name:"danger-color",label:"Danger",type:"color"},{name:"warning-color",label:"Warning",type:"color"},{name:"info-color",label:"Info",type:"color"}]},{category:"Nodes",tokens:[{name:"node-bg",label:"Background",type:"color"},{name:"node-border",label:"Border",type:"color"},{name:"node-border-width",label:"Border Width",type:"range",min:0,max:10,unit:"px"},{name:"node-radius",label:"Corner Radius",type:"range",min:0,max:50,unit:"px"},{name:"node-focus-color",label:"Selected Color",type:"color"},{name:"node-focus-width",label:"Selected Width",type:"range",min:0,max:10,unit:"px"}]},{category:"Labels",tokens:[{name:"label-color",label:"Text Color",type:"color"},{name:"label-font-size",label:"Font Size",type:"range",min:8,max:24,unit:"px"}]},{category:"Ports",tokens:[{name:"port-size",label:"Size",type:"range",min:4,max:20,unit:"px"},{name:"port-radius",label:"Corner Radius",type:"range",min:0,max:50,unit:"%"},{name:"port-bg",label:"Input Background",type:"color"},{name:"port-output-bg",label:"Output Background",type:"color"},{name:"port-border",label:"Border",type:"color"}]},{category:"Connections",tokens:[{name:"conn-color",label:"Color",type:"color"},{name:"conn-width",label:"Width",type:"range",min:1,max:10,unit:"px"},{name:"conn-hover-color",label:"Hover Color",type:"color"},{name:"conn-selected-color",label:"Selected Color",type:"color"},{name:"conn-bad-color",label:"Bad Color",type:"color"}]},{category:"Grid",tokens:[{name:"grid-type",label:"Type",type:"select",options:[{label:"Dots",value:"dots"},{label:"Lines",value:"lines"}]},{name:"grid-dot-color",label:"Dot Color",type:"color"},{name:"grid-dot-size",label:"Dot Size",type:"range",min:10,max:100,unit:"px"},{name:"grid-dot-radius",label:"Dot Radius",type:"range",min:.5,max:5,step:.1,unit:"px"},{name:"grid-line-color",label:"Line Color",type:"color"},{name:"grid-line-size",label:"Line Size",type:"range",min:10,max:100,step:10,unit:"px"},{name:"grid-line-width",label:"Line Width",type:"range",min:1,max:5,unit:"px"}]}]}html(){return`      \n            <button class="floxy-toggle-btn" id="floxy-theme-toggle" title="Customize Theme">\n                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">\n                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>\n                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.185 1.184l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.184 1.185l-.292-.159a1.873 1.873 0 0 0-2.692 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.291.16c-.764.415-1.6-.42-1.185-1.184l.159-.292a1.873 1.873 0 0 0-1.116-2.692l-.318-.094c-.835-.246-.835-1.428 0-1.674l.319-.094a1.873 1.873 0 0 0 1.115-2.693l-.16-.291c-.415-.764.42-1.6 1.184-1.185l.292.159a1.873 1.873 0 0 0 2.692-1.116l.094-.318z"/>\n                </svg>\n            </button>\n            <div class="floxy-theme-editor swag" id="floxy-theme-panel">\n                <div class="floxy-theme-header">\n                    <h5 class="m-0 fw-bold" style="font-size: 0.95rem; color: var(--floxy-label-color);">Theme Editor</h5>\n                    <button type="button" class="btn-close" id="floxy-theme-close" style="font-size: 0.7rem; opacity: 0.6; color: var(--floxy-node-text);"></button>\n                </div>\n                <div class="floxy-theme-body">\n                    ${this.renderTokenControl()}\n                </div>\n                <div class="floxy-theme-footer">\n                    <button class="btn btn-sm btn-primary flex-grow-1 py-2" id="floxy-download-theme">Download Theme</button>\n                    <button class="btn btn-sm btn-outline-secondary flex-grow-1 py-2" id="floxy-export-css">Copy CSS</button>\n                    <button class="btn btn-sm btn-link w-100 mt-2" id="floxy-theme-reset" style="font-size: 0.75rem; text-decoration: none;  color: var(--floxy-secondary-color)">Reset Defaults</button>\n                </div>\n            </div>\n        `}render(){this.container.innerHTML=this.html(),this.attachEvents()}init(){this.render()}renderTokenControl(){return this.config.map(t=>`\n            <div class="floxy-theme-section">\n              ${this.#d(t)}\n            </div>\n          `).join("")}#d(t){const e=t.group??!1;let n=`<h6>${t.category}</h6>`;return e?(n+='<div style="display: flex; gap: 8px; flex-wrap: wrap;">',t.tokens.forEach(t=>{const e=this.manager.getToken(t.name);n+=`<input type="color" title="${t.label}" class="floxy-color-input" data-token="${t.name}" value="${this.rgbToHex(e)}">`}),n+="</div>",n):(n+=`${t.tokens.map(t=>this.#c(t)).join("")}`,n)}#c(t){return"color"===t.type?this.#p(t):"range"===t.type?this.#m(t):"select"===t.type?this.#u(t):void 0}#p(t){const e=this.manager.getToken(t.name);return`\n        <div class="floxy-token-row">\n          <span class="floxy-token-label">${t.label}</span>\n          <input type="color" class="floxy-color-input" data-token="${t.name}" value="${this.rgbToHex(e)}">\n        </div>\n      `}#m(t){const e=this.manager.getToken(t.name),n=parseFloat(e)||0;return`\n        <div class="floxy-token-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">\n          <div style="display: flex; justify-content: space-between; align-items: center;">\n            <span class="floxy-token-label">${t.label}</span>\n            <span class="floxy-range-value" id="val-${t.name}">${e}</span>\n          </div>\n          <input type="range" class="form-range floxy-range-input" \n            data-token="${t.name}" \n            data-unit="${t.unit||""}"\n            min="${t.min}" max="${t.max}" step="${t.step||1}" \n            value="${n}">\n        </div>\n      `}#u(t){const e=this.manager.getToken(t.name)||t.options[0].value;return`\n        <div class="floxy-token-row">\n          <span class="floxy-token-label">${t.label}</span>\n          <select class="form-select form-select-sm floxy-select-input w-50" data-token="${t.name}" style="font-size: 0.75rem;">\n            ${t.options.map(t=>`<option value="${t.value}" ${e===t.value?"selected":""}>${t.label}</option>`).join("")}\n          </select>\n        </div>\n      `}attachEvents(){const t=this.container.querySelector("#floxy-theme-panel"),e=this.container.querySelector("#floxy-theme-toggle"),n=this.container.querySelector("#floxy-theme-close"),o=this.container.querySelector("#floxy-theme-reset"),s=this.container.querySelector("#floxy-export-css"),i=this.container.querySelector("#floxy-download-theme");e.onclick=()=>{this.isOpen=!this.isOpen,t.classList.toggle("open",this.isOpen)},n.onclick=()=>{this.isOpen=!1,t.classList.remove("open")},t.querySelectorAll("input, select").forEach(t=>{const e=t=>{const e=t.target.dataset.token,n=t.target.dataset.unit||"",o=t.target.value+n;"global-theme"===e?this.manager.setGlobalTheme(t.target.value):this.manager.setToken(e,o);const s=this.container.querySelector(`#val-${e}`);s&&(s.textContent=o)};t.oninput=e,t.onchange=e}),o.onclick=t=>{t.preventDefault(),confirm("Reset all theme variables to defaults?")&&window.location.reload()},s.onclick=()=>{let t=":root {\n";this.config.forEach(e=>{e.tokens.forEach(e=>{t+=`  --floxy-${e.name}: ${this.manager.getToken(e.name)};\n`})}),t+="}",navigator.clipboard.writeText(t).then(()=>{const t=s.textContent;s.textContent="Copied!",s.classList.add("btn-success"),s.classList.remove("btn-outline-secondary"),setTimeout(()=>{s.textContent=t,s.classList.remove("btn-success"),s.classList.add("btn-outline-secondary")},2e3)})},i.onclick=()=>{let t="/* Generated by Floxy Theme Editor */\n:root {\n";this.config.forEach(e=>{e.tokens.forEach(e=>{t+=`  --floxy-${e.name}: ${this.manager.getToken(e.name)};\n`})}),t+="}";const e=new Blob([t],{type:"text/css"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download="floxy-theme.css",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}}rgbToHex(t){if(t.startsWith("#"))return t;const e=t.match(/\d+/g);return!e||e.length<3?"#000000":"#"+e.slice(0,3).map(t=>{const e=parseInt(t).toString(16);return 1===e.length?"0"+e:e}).join("")}},t.ThemeManager=Q,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
