var floxy=function(t){"use strict";class e{constructor(t,e,n={x:0,y:0},i={x:0,y:0},s=1,o="grabbing",a="grab"){this.element=t,this.onMoveHandler=e,this.zoomGetter="function"==typeof s?s:()=>s,this.isDragging=!1,this.dragStartPosition=i,this.initialPosition=n,this.elementX=this.initialPosition.x,this.elementY=this.initialPosition.y,this.rafId=null,this.onMoveCursor=o,this.onReleaseCursor=a,this.MOUSE_RIGHT_CLICK=2}destroy(){this.element.removeEventListener("mousedown",this.onHold.bind(this)),window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))}registerDragEvent(){this.element.addEventListener("mousedown",this.onHold.bind(this))}onHold(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!0,this.dragStartPosition={x:t.clientX,y:t.clientY},this.initialPosition={x:this.elementX,y:this.elementY},this.element.style.cursor=this.onMoveCursor,window.addEventListener("mousemove",this.onMove.bind(this)),window.addEventListener("mouseup",this.onRelease.bind(this)),this.startRaf()):console.debug("FLOW: Ignoreing Right click on ",this.element)}onMove(t){if(t.button===this.MOUSE_RIGHT_CLICK)return void console.debug("FLOW: Ignoreing Right click on",this.element);if(t.stopPropagation(),!this.isDragging)return;const e=this.zoomGetter(),n=(t.clientX-this.dragStartPosition.x)/e,i=(t.clientY-this.dragStartPosition.y)/e;this.elementX=this.initialPosition.x+n,this.elementY=this.initialPosition.y+i}onRelease(t){t.button!==this.MOUSE_RIGHT_CLICK?(t.stopPropagation(),this.isDragging=!1,this.element.style.cursor=this.onReleaseCursor,window.removeEventListener("mousemove",this.onMove.bind(this)),window.removeEventListener("mouseup",this.onRelease.bind(this))):console.debug("FLOW: Ignoreing right click on",this.element)}static register(t,n,i=1){const s=new e(t,n,{x:0,y:0},{x:0,y:0},i);return s.registerDragEvent(),s}startRaf(){if(this.rafId)return;const t=()=>{if(!this.isDragging)return cancelAnimationFrame(this.rafId),void(this.rafId=null);this.onMoveHandler(this.elementX,this.elementY),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}}const n="canvas:zoom",i="node:removed",s="node:moved",o="node:selected",a="node:deselected",r="node:dropped",h="node:updated",d="node:label:updated",c="node:port:connect:start",l="node:port:connect:end",u="connection:created",p="connection:removed",m="connection:clicked",g="bezier",v="selectable",w="movable",y="editable-label",C="resizable",b=[v,w,y,C],f=["ellipse","circle","rect","line","polyline","polygon","path"];class x{constructor({node:t,options:e={}}){this.node=t,this.options=e,this.attached=!1}static get behavior(){throw new Error("Static property behavior must be implemented in the subclass")}isSupported(){const t=this.node.isCapabilitySupported(this.constructor.behavior);return console.debug("FLOW: Is behavior supported",this.constructor.behavior,t),t}_attach(){this.isSupported()&&this.gaurd()&&(this.attach(),this.attached=!0,this.node.on(i,this.destroy))}gaurd(){return!0}attach(){throw new Error("Method 'attach()' must be implemented in the subclass")}detach(){throw new Error("Method 'detach()' must be implemented in the subclass")}destroy(){this.detach(),this.node.off(i,this.destroy)}}let E=new class{constructor(){this._registry=new Map}register(t){const e=t.behavior;if(!e)throw new Error(`Behavior ${t.name} must define static behavior`);this._registry.set(e,t)}get(t){return this._registry.get(t)}getAll(){return Array.from(this._registry.values())}};let I=new class{constructor(){this.paths=new Map}register(t,e){this.paths.set(t,e)}get(t){return this.paths.get(t)}has(t){return this.paths.has(t)}};I.register("line",({p1:t,p2:e,options:n={}})=>`M ${t.x} ${t.y} L ${e.x} ${e.y}`),I.register("bezier",({p1:t,p2:e,options:n={}})=>{const i=n.curvature??.7,s=t.x+Math.abs(e.x-t.x)*i,o=e.x-Math.abs(e.x-t.x)*i;return`M ${t.x} ${t.y}\n            C ${s} ${t.y} ${o} ${e.y} ${e.x} ${e.y}`}),I.register("orthogonal",({p1:t,p2:e,sourceBounds:n,targetBounds:i,sourceDir:s="right",targetDir:o="left",options:a={}})=>{const r=i?.height||50,h="vertical"===a.direction,d=a.clearance??60,c=t.x+d,l=t.y+d,u=h?e.y>l+40:e.y+1>t.y,p=h?e.x+1>t.x:e.x>c+40,m=[`M ${t.x} ${t.y}`];m.push(`L ${c} ${t.y}`);let g=Math.abs(e.y-t.y),v=Math.abs(t.x-e.x);if(u)if(p)m.push(`v ${g}`),m.push("h "+(v-d));else{let t=.9*(g-r),n=g-t,i=Math.abs(c+40-e.x);m.push(`v ${t}`),m.push("h "+-1*i),m.push(`v ${n}`),m.push(`L ${e.x} ${e.y}`)}else if(p)m.push("v "+-1*g),m.push("h "+(v-d));else{let t=.9*(g-r),n=g-t,i=Math.abs(c+40-e.x);m.push("v "+-1*t),m.push("h "+-1*i),m.push("v "+-1*n),m.push(`L ${e.x} ${e.y}`)}return m.join(" ")});class P{constructor({name:t}){if(new.target===P)throw new TypeError("Cannot construct Component instances directly");this.name=t,this.containerID=this.name?this.name.toLowerCase().replace(/\s+/g,"-"):`tab-${Math.random().toString(36).substring(2,15)}`,this.id=this.containerID,this.container=null,this.created=!1,this.rendered=!1,this.parentContainer=null,this.onlyChild=null}renderInto(t,e=!1){let n;if(this.onlyChild=e,this.isRendered())console.warn(`'${this.name}' component is already rendered.`);else{if("string"==typeof t){if(n=document.getElementById(t),!n)throw new Error(`Container with id ${t} not found`)}else{if(!(t instanceof HTMLElement))throw new Error("Container must be a valid HTMLElement or a string ID.");n=t}if(!n.id)throw new Error("Container must have a valid id.");this.parentContainer=n,this.createContainer(),this.onlyChild?this.parentContainer.replaceChildren(this.container):this.parentContainer.appendChild(this.container),console.log("DOM is rendered into container ",n.id),this.rendered=!0}}getParentContainer(){return this.rendered?this.parentContainer:(console.warn(`'${this.name}' component is not rendered yet.`),null)}createContainer(){return this.isCreated()?this.container?this.container:void console.warn(`${this.component} component is already rendered.`):(this.container=this.#t(),this.initContainer(),this.container)}getContainer(){return this.container||this.createContainer(),this.container}#t(){const t=document.createElement("div");t.id=this.containerID,t.style.height="100%",t.style.width="100%";const e=this.html();return t.insertAdjacentHTML("beforeend",e),t}initContainer(){this.init(),this.created=!0}isCreated(){return this.created}isRendered(){return this.rendered}init(){throw new Error("Method 'init()' must be implemented in the subclass")}html(){throw new Error("Method '#html()' must be implemented in the subclass")}}class M extends P{constructor({name:t}){super({name:t}),this.events={}}on(t,e){(this.events[t]||=[]).push(e)}emit(t,e){(this.events[t]||[]).forEach(t=>t(e))}off(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(t=>t!==e))}clear(t){t?delete this.events[t]:this.events={}}}class N extends M{constructor({name:t,options:e={}}){super({name:t}),this.options=e,this.zoom=e.zoom||1,this.enableZoomActions=e.enable_zoom_actions||!0,this.originalZoom=this.zoom,this.canvasX=e.canvas?.x||0,this.canvasY=e.canvas?.y||0,this.canvasId=this.id+"-canvas",this.containerId=this.id+"-flow-container",this.zoomActionsId=this.id+"-zoom-actions",this.arrowMarkerSize=e.arrow_marker_size||7}html(){return`\n            <div id="${this.canvasId}" \n                class="flow-canvas" \n                style="transform: translate(${this.canvasX}px, ${this.canvasY}px) scale(${this.zoom})">\n                <svg id="${this.id}-svg" class="flow-connections"></svg>\n            </div>\n            ${this.enableZoomActions?`<div id="${this.zoomActionsId}" class="zoom-actions"></div>`:""}\n        `}init(){this.containerEl=this.parentContainer,this.canvasEl=this.container.querySelector(`#${this.canvasId}`),this.svgEl=this.container.querySelector(`#${this.id}-svg`),this.container=this.canvasEl,e.register(this.containerEl,this.redrawCanvasWithXY.bind(this)),this.enableZoomActions&&this.containerEl.addEventListener("wheel",this.onCanvasWheelZoom.bind(this),{passive:!1}),this.containerEl.addEventListener("dragover",t=>t.preventDefault()),this.containerEl.addEventListener("drop",this.onDrop.bind(this)),function(t,e=5){if(t.querySelector("#arrow-end"))return;const n=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=(t,n)=>{const i=document.createElementNS("http://www.w3.org/2000/svg","marker");i.setAttribute("id",t),i.setAttribute("markerWidth",e),i.setAttribute("markerHeight",e),i.setAttribute("refX",e),i.setAttribute("refY",e/2),i.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",n),s.setAttribute("fill","currentColor"),i.appendChild(s),i};n.appendChild(i("arrow-end",`M 0 0 L ${e} ${e/2} L 0 ${e} Z`)),n.appendChild(i("arrow-start",`M ${e} 0 L 0 ${e/2} L ${e} ${e} Z`)),t.appendChild(n)}(this.svgEl,this.arrowMarkerSize)}redrawCanvas(){this.redrawCanvasWithXY(this.canvasX,this.canvasY)}redrawCanvasWithXY(t,e){this.canvasX=t,this.canvasY=e,this.canvasEl.style.transform=`translate(${t}px, ${e}px) scale(${this.zoom})`;const n=this.gridFactor*this.zoom;this.containerEl.style.backgroundSize=`${n}px ${n}px`,this.containerEl.style.backgroundPosition=`${t}px ${e}px`}onCanvasWheelZoom(t){t.preventDefault(),console.log("FLOW: Wheel on canvas with deltaY: ",t.deltaY);const e=t.deltaY>0?-.1:.1,i=Math.max(.1,Math.min(this.zoom+e,3));this.zoom=i,this.redrawCanvas(),this.emit(n,{data:{zoom:this.zoom,x:this.canvasX,y:this.canvasY,delta:e,originalZoom:this.originalZoom}})}onDrop(t){t.preventDefault(),t.stopPropagation();try{const e=t.dataTransfer.getData("module"),n=t.dataTransfer.getData("group"),i=t.dataTransfer.getData("name"),s=t.dataTransfer.getData("label"),o=t.dataTransfer.getData("data");if(!e||!n||!i)return;let a;try{a=o?JSON.parse(o):{}}catch(t){console.error("Invalid drop data",t),a={}}const h=this.containerEl.getBoundingClientRect(),d=t.clientX-h.left-this.canvasX,c=t.clientY-h.top-this.canvasY;this.emit(r,{module:e,group:n,name:i,label:s,x:d,y:c,data:a}),console.debug("FLOW - DROP: ",e,n,i,s,d,c,a)}catch(t){console.error("Invalid drop data",t)}}}class S extends M{constructor({model:t,view:e,behaviors:n=new Set}){super({name:`node-${t.id}`}),this.id=t.id,this.name=t.name,this.model=t,this.view=e,this.behaviors=n,this.destroyed=!1}html(){return""}setBehaviors(t){this.behaviors=t}addBehavior(t){this.behaviors.add(t)}removeBehavior(t){this.behaviors.delete(t)}renderInto(t){this.view.renderInto(t)}init(){this.behaviors.forEach(t=>t._attach())}move(t,e){this.model.move(t,e),this.view.move(),this.emit(s,{id:this.id,x:t,y:e})}onResize(t,e){const{x:n,y:i}=this.model;this.model.resize(t,e),this.view.resizeNode(),this.emit(h,{id:this.id,x:n,y:i,w:t,h:e})}destroy(){this.behaviors.forEach(t=>t.detach?.()),this.behaviors.clear(),this.view.destroy(),this.view=null,this.behaviors=null,this.model=null,this.destroyed=!0}isCapabilitySupported(t){return this.model.capabilities.includes(t)}get x(){return this.model.x}get y(){return this.model.y}get w(){return this.model.w}get h(){return this.model.h}select(){this.view.setSelected(!0),this.emit(o,{id:this.model.id})}deselect(){this.view.setSelected(!1),this.emit(a,{id:this.model.id})}}const L=[v,w];class ${constructor({id:t,name:e,label:n,module:i="default",group:s="default",inputs:o=1,outputs:a=1,x:r=0,y:h=0,h:d=100,w:c=200,data:l={},capabilities:u=L}){this.id=t,this.module=i,this.group=s,this.name=e,this.inputs=o,this.outputs=a,this.x=r,this.y=h,this.h=d,this.w=c,this.data=l,this.capabilities=u,this.label=n??this.name}move(t,e){this.x=t,this.y=e}resize(t,e){this.w=t,this.h=e}}const z=new class{constructor(){this.views=new Map}register(t){const e=t.modelDefaults;this.views.set(e.module+":"+e.group+":"+e.name,t)}get(t,e,n){return this.views.get(t+":"+e+":"+n)}};class k extends M{constructor(t,e={}){if(!(t instanceof $))throw new Error("Model must be an instance of NodeModel");super({name:`node-${t.id}`}),this.model=t,this.options=e,this.el=null,this.contentId=`content-${t.id}`,this.zoomGetter=e.zoomGetter||(()=>this.options.zoom??1),this._content=null,this.close=null}static get modelDefaults(){return{inputs:1,outputs:1,w:200,h:50,label:"Node",group:"default",module:"default",capabilities:b,data:{}}}html(){return this._content=this.getNodeElement(),"string"==typeof this._content?this._content:""}init(){this.el=this.container,this.updateContainerAttributes(),this._content&&("string"==typeof this._content?this.el.innerHTML=this._content:this.el.appendChild(this._content)),this.createAllPorts(),this._bindEvents(),this.bindEvents()}updateContainerAttributes(){this.container.dataset.id="node-"+this.model.id,this.container.dataset.name=this.model.name,this.container.dataset.module=this.model.module,this.container.dataset.group=this.model.group,this.container.style.top=`${this.model.y}px`,this.container.style.left=`${this.model.x}px`,this.container.style.width=`${this.model.w}px`,this.container.style.height=`${this.model.h}px`,this.container.style.position="absolute",this.container.classList.add("flow-node")}createAllPorts(){const t=this.createPorts({type:"input",count:this.model.inputs}),e=this.createPorts({type:"output",count:this.model.outputs}),n=this.createClose();this.close=n,this.el.prepend(t),this.el.appendChild(e),this.el.appendChild(n)}destroy(){this.el?.remove(),this.el=null}propagateEvent(t,e){e.on(t,e=>this.emit(t,e))}querySelector(t){return this.el.querySelector(t)}setSelected(t){this.el.classList.toggle("selected",t)}move(){this.el.style.top=`${this.model.y}px`,this.el.style.left=`${this.model.x}px`}getPortPosition({type:t,index:e}){if(!this.el)return null;const n=this.el.querySelector(`.flow-port[data-type="${t}"][data-index="${e}"]`);if(!n)return null;const i=this.el.getBoundingClientRect(),s=n.getBoundingClientRect(),o="function"==typeof this.zoomGetter?this.zoomGetter():1,a=(s.left-i.left+s.width/2)/o,r=(s.top-i.top+s.height/2)/o;return{x:this.model.x+a,y:this.model.y+r}}getBounds(){const t=this.el;return{left:t.offsetLeft,top:t.offsetTop,right:t.offsetLeft+t.offsetWidth,bottom:t.offsetTop+t.offsetHeight,width:t.offsetWidth,height:t.offsetHeight}}createPorts({type:t,count:e}){const n=document.createElement("div");n.className=`flow-ports-column flow-ports-${t}`;for(let i=0;i<e;i++){const e=document.createElement("div");e.className="flow-port",e.dataset.type=t,e.dataset.index=i,e.dataset.nodeId=this.model.id,n.appendChild(e)}return n}createClose(){const t=document.createElement("button");return t.className="btn-danger btn-close node-close border rounded shadow-none m-1",t.dataset.nodeId=this.model.id,t.setAttribute("aria-label","Close"),t}_bindEvents(){console.debug("FLOW: Bind events",this.name),this.bindMouseDown(),this.bindRemoveNode(),this.bindOutputPorts(),this.bindInputPorts()}bindRemoveNode(){this.el.querySelector(".node-close")?.addEventListener("click",t=>{t.stopPropagation(),this.emit(i,{id:this.model.id})})}bindMouseDown(){this.el.addEventListener("mousedown",t=>{this.emit("node:pointer:down",{event:t})})}bindInputPorts(){this.el.querySelectorAll(".flow-ports-input .flow-port").forEach(t=>{t.addEventListener("mouseup",e=>{console.debug("FLOW: Port connect end",e),this.emit(l,{nodeId:this.model.id,portIndex:t.dataset.index,event:e})})})}bindOutputPorts(){this.el.querySelectorAll(".flow-ports-output .flow-port").forEach(t=>{t.addEventListener("mousedown",e=>{console.debug("FLOW: Port connect start",e),this.emit(c,{nodeId:this.model.id,portIndex:t.dataset.index,event:e})})})}resizeNode(){this.el.style.width=`${this.model.w}px`,this.el.style.height=`${this.model.h}px`,this.resize?.()}getNodeElement(){}bindEvents(){}}class _ extends k{constructor(t,e={}){super(t,e)}static get name(){return"default-node-view"}getNodeElement(){return`\n        <div class="node" style="display: grid; place-items: center;">\n            <div class="node-label">${this.model.label}</div>\n        </div>\n    `}}class A{constructor({registry:t}){this.registry=t}resolve(t,e={}){const n=new Set;return t.model.capabilities.forEach(i=>{const s=this.registry.get(i);s&&n.add(new s({node:t,options:e}))}),n}}class D extends M{constructor({name:t,canvasContainer:e,zoomGetter:n=()=>1,View:i=_,viewRegistry:s=z,BehaviorRegistryCls:o=E,BehaviorResolverCls:a=A}){super({name:t+"node-manager"}),this.canvasContainer=e,this.zoomGetter=n,this.View=i,this.viewRegistry=s,this.nodes=new Map,this.idCounter=1,this.BehaviorRegistryCls=o,this.BehaviorResolverCls=a,this.behaviorResolver=new this.BehaviorResolverCls({registry:this.BehaviorRegistryCls}),this.behaviors=[]}dropNode(t){console.debug("FLOW: Drop node",t),this.addNode(t,!0)}addNode(t,e=!1){console.debug("FLOW: Add node",t);let n=this.viewRegistry.get(t.module,t.group,t.name);n||(console.warn("No nodeview fond for {",t.module,t.group,t.name,"}. Using default view."),n=this.View);const i=n.modelDefaults;if(e){const e=this.zoomGetter(),n=t.h??i.h??100,s=t.w??i.w??200,o=(t.x-s/2)/e,a=(t.y-n/2)/e;t.x=o,t.y=a}Object.keys(i).forEach(e=>{const n=t[e];void 0!==n&&"undefined"!==n||(t[e]=i[e])});const s=this.#e(t,n);return s.renderInto(this.canvasContainer),s.init(),this.nodes.set(s.id,s),s.id}#e(t,e){const n=this.idCounter++,r=new $({id:n,...t}),u=new e(r,{...this.options,zoomGetter:this.zoomGetter}),p=new S({model:r,view:u}),m=this.behaviorResolver.resolve(p,this.options);return p.setBehaviors(m),this.propagateEvent(c,u),this.propagateEvent(l,u),this.propagateEvent(o,u),this.propagateEvent(a,u),this.propagateEvent(s,p),this.propagateEvent(h,p),this.propagateEvent(d,p),u.on(i,t=>this.removeNode(t.id)),p}removeNode(t){let e=this.getNode(t);e&&(e.destroy(),this.nodes.delete(t),this.emit(i,{id:t}),e=null)}propagateEvent(t,e){e.on(t,e=>this.emit(t,e))}reset(){Object.values(this.nodes).forEach(t=>{t.destroy()}),this.nodes.clear(),this.idCounter=1}getNode(t){return this.nodes.get(t)}getAllNodes(){return[...this.nodes.values()]}get size(){return this.nodes.size}}var T=window.getComputedStyle(document.body);class R{constructor(t,e={}){this.secondaryColor=T.getPropertyValue("--bs-secondary"),this.primaryColor=T.getPropertyValue("--bs-primary"),this.dangerColor=T.getPropertyValue("--bs-danger"),this.stroke=e.stroke??void 0,this.width=e.width??2,this.dash=e.dash??null,this.animated=!!e.animated,this.path=t??g,I.has(this.path)||(console.warn(`Path ${this.path} not found. setting to default path type ${g}.`),this.path=g),this.arrows={start:e.arrows?.start??!1,end:e.arrows?.end??!0},this.bad=!1,this.hover=!1,this.selected=!1,this.temp=!1,this.execution=e.execution??!1,this.speed=e.execution_speed??2}markBad(t=!0){this.bad=t}markHover(t=!0){this.hover=t}markSelected(t=!0){this.selected=t}markTemp(t=!0){this.temp=t}markExecution(t=!0){this.execution=t}applyTo(t){this.stroke&&(t.style.stroke=this.stroke),t.style.strokeWidth=this.width,t.style.strokeDasharray=this.dash??"",t.classList.toggle("animated",this.animated),t.classList.toggle("flow-connection-temp",this.temp),t.classList.toggle("flow-connection-path-bad",this.bad),t.classList.toggle("selected",this.selected),t.classList.toggle("path-hover",this.hover),this.execution?(t.style.strokeDasharray="6 4",t.style.animation=`flow ${1/this.speed}s linear infinite`):(t.style.strokeDasharray=this.dash??"",t.style.animation="")}}class B extends M{constructor({id:t,outNodeId:e,outPort:n,inNodeId:i,inPort:s,options:o={}}){super({name:`connection-${t}`}),this.id=t,this.outNodeId=e,this.outPort=n,this.inNodeId=i,this.inPort=s,this.options=o,this.style={width:2,dash:null,animated:!1,...o.style},this.style=new R(this.pathType,this.style)}get source(){return{nodeId:this.outNodeId,portIndex:this.outPort}}get target(){return{nodeId:this.inNodeId,portIndex:this.inPort}}get arrows(){return this.style.arrows}get pathType(){return this.options.pathType??g}}class O extends M{#n=null;#i=null;constructor({model:t,nodeManager:e,options:n={}}){super({name:`connection-view-${t.id}`}),this.model=t,this.nodeManager=e,this.path=null,this.shadowPath=null,this.options=n,this.container=null,this.#n=null,this.#i=null,this.adjustEnd=!1,this.adjustStart=!1,this.adjustOffset=6,this.endMarker=!0,this.startMarker=!0,this.isTemp=n.isTemp??!1}html(){return""}init(){this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.path.classList.add("flow-connection-path","connection"),this.path.setAttribute("id",this.model.id),this.parentContainer.appendChild(this.path),this.container=this.path,this.initShadowPath(),this.bindEvents(),this.applyArrows()}static getConnectionKey(t,e,n,i){return`${t}:${e}-${n}:${i}`}applyArrows(){const t=this.model.arrows||{};this.endMarker=t.end??this.endMarker,this.startMarker=t.start??this.startMarker,this.path.removeAttribute("marker-start"),this.path.removeAttribute("marker-end"),this.startMarker&&(this.adjustStart=!0,this.path.setAttribute("marker-start","url(#arrow-start)")),this.endMarker&&(this.adjustEnd=!0,this.path.setAttribute("marker-end","url(#arrow-end)"))}initShadowPath(){this.shadowPath=document.createElementNS("http://www.w3.org/2000/svg","path"),this.shadowPath.classList.add("flow-connection-path","shadow-path"),this.shadowPath.setAttribute("id","shadow-"+this.model.id),this.shadowPath.style.stroke="transparent",this.shadowPath.style.strokeWidth=18,this.shadowPath.style.fill="none",this.shadowPath.style.pointerEvents=this.isTemp?"none":"stroke",this.parentContainer.appendChild(this.shadowPath)}applyStyle(){this.model.style.applyTo(this.path)}#s(t,e){let n=t,i=e;return this.adjustEnd&&(i={x:e.x-this.adjustOffset,y:e.y}),this.adjustStart&&(n={x:t.x+this.adjustOffset+16,y:t.y}),{p1:n,p2:i}}update(t,e,n={}){if(!t||!e)return;const i=t.view.getPortPosition({type:"output",index:this.model.source.portIndex}),s=e.view.getPortPosition({type:"input",index:this.model.target.portIndex});i&&s&&this.#o(i,s,n)}updateTempPath(t,e,n={}){this.model.style.markTemp(!0),this.path.style.pointerEvents="none",this.#o(t,e,n)}#o(t,e,n={}){const i=this.#s(t,e);this.updatePath(i.p1,i.p2,n)}updatePath(t,e,n={}){const i=this.model.style.path??"bezier";this.#n=t??this.#n,this.#i=e??this.#i;const s=I.get(i)({p1:this.#n,p2:this.#i,...n,zoom:this.options.zoom});this.shadowPath.setAttribute("d",s),this.path.setAttribute("d",s),this.path.setAttribute("p1x",t.x),this.path.setAttribute("p1y",t.y),this.path.setAttribute("p2x",e.x),this.path.setAttribute("p2y",e.y),this.applyStyle(),this.applyArrows()}addStyleClass(t){this.path.classList.add(t)}removeStyleClass(t){this.path.classList.remove(t)}destroy(){this.path?.remove(),this.shadowPath?.remove(),this.path=null,this.shadowPath=null}bindEvents(){this.bindSelect(),this.bindShadowSelect()}bindSelect(){this.path.addEventListener("click",t=>{t.stopPropagation(),this.emit(m,this.model.id)})}bindShadowSelect(){this.shadowPath.addEventListener("mouseover",t=>{t.stopPropagation(),this.model.style.markHover(!0),this.applyStyle()}),this.shadowPath.addEventListener("mouseout",t=>{t.stopPropagation(),this.model.style.markHover(!1),this.applyStyle()}),this.shadowPath.addEventListener("click",t=>{t.stopPropagation(),this.emit(m,this.model.id)})}_polyline(t){return t.map((t,e)=>0===e?`M ${t.x} ${t.y}`:`L ${t.x} ${t.y}`).join(" ")}}class W extends M{constructor({model:t,view:e,nodeManager:n}){super({name:`connection-${t.id}`}),this.model=t,this.view=e,this.nodeManager=n,this.destroyed=!1,this._source=null,this._target=null,this.id=this.model.id}get outNodeId(){return this.model.outNodeId}get inNodeId(){return this.model.inNodeId}get inPort(){return this.model.inPort}get outPort(){return this.model.outPort}get source(){return this._source||(this._source={nodeId:this.model.source.nodeId,portIndex:this.model.source.portIndex}),this._source}get target(){return this._target||(this._target={nodeId:this.model.target.nodeId,portIndex:this.model.target.portIndex}),this._target}renderInto(t){this.view.renderInto(t),this.init()}init(){this.update()}update(){const t=this.nodeManager.getNode(this.model.source.nodeId),e=this.nodeManager.getNode(this.model.target.nodeId),n={sourceBounds:t.view.getBounds(),targetBounds:e?.view.getBounds()};this.view.update(t,e,n)}updateWithXY(t,e){const n=this.nodeManager.getNode(this.source.nodeId);if(!n)return;const i=n.view.getPortPosition({type:"output",index:this.source.portIndex}),s={x:t,y:e},o={sourceBounds:n.view.getBounds()};this.view.updateTempPath(i,s,o)}markBadPath(){this.model.style.markBad(!0),this.view.applyStyle()}destroy(){this.view.destroy(),this.view=null,this.model=null,this.nodeManager=null,this.destroyed=!0}clearBadPath(){this.model.style.markBad(!1),this.view.applyStyle()}setPathStyle(t){this.model.pathType=t,this.view.updatePath()}}class H extends M{constructor({name:t,connectionContainer:e,nodeManager:n,options:i={}}){super({name:t+"-flow-connection-manager",options:i}),this.connectionContainer=e,this.nodeManager=n,this.options=i,this.zoom=i.zoom||1,this.originalZoom=this.zoom,this.nodeIdCounter=1,this.nodeWidth=i.nodeWidth||200,this.nodeHeight=i.nodeHeight||90,this.connections=new Map,this.tempConnection=null,this.badConnections=new Set}addConnection(t,e,n,i,s=void 0){const o=O.getConnectionKey(t,e,n,i),a=this.#a({id:o,outNodeId:t,outPort:e,inNodeId:n,inPort:i,pathType:s,isTemp:!1});return this.connections.set(o,a),a}beginTempConnection(t,e,n=void 0){const i=this.#a({id:"temp",outNodeId:t,outPort:e,inNodeId:null,inPort:null,pathType:n,isTemp:!0});return this.tempConnection=i,i}#a({id:t,outNodeId:e,outPort:n,inNodeId:i,inPort:s,pathType:o,isTemp:a=!1}){const r=o??this.options?.connection?.path_type??g,h={...this.options?.connection,pathType:r},d=new B({id:t,outNodeId:e,outPort:n,inNodeId:i,inPort:s,options:h}),c=new O({model:d,options:{...h,isTemp:a}}),l=new W({model:d,view:c,nodeManager:this.nodeManager,options:h});return l.renderInto(this.connectionContainer.id),c.on(m,t=>{this.removeConnection(t)}),l}reset(){this.connections.forEach(t=>t.destroy()),this.connections.clear(),this.clearTempPath?.()}updateConnections(t){const e=parseInt(t);this.connections.forEach((t,n)=>{t.source.nodeId!==e&&t.target.nodeId!==e||(t.update(),this.emit("connection:updated",t))})}updateTempConnection(t,e){this.tempConnection&&(this.clearBadPaths(),this.tempConnection.updateWithXY(t,e))}removeConnection(t){const e=this.getConnection(t);this.emit(p,t),this.connections.delete(t),e?.destroy()}removeRelatedConnections(t){this.connections.forEach((e,n)=>{e.source.nodeId!==t&&e.target.nodeId!==t||this.removeConnection(n)})}endTempConnection(){this.clearTempPath(),this.tempConnection=null}clearTempPath(){this.clearBadPaths(),this.tempConnection&&(this.tempConnection.destroy(),this.tempConnection=null)}markTempPathBad(){this.tempConnection&&this.markPathBad(this.tempConnection)}markPathBad(t){t.markBadPath(),this.badConnections.add(t)}clearBadPaths(){this.badConnections.forEach(t=>{t.clearBadPath()}),this.badConnections.clear()}getZoom(){return this.zoom}getAllConnections(){return[...this.connections.values()]}getConnection(t){return this.connections.get(t)}get size(){return this.connections.size}}class Y{export(t){const e=t.nodeManager,n=t.connectionManager,i=t.canvas,s=[];e.getAllNodes().forEach(t=>{s.push(t.model)});const o=[];return n.getAllConnections().forEach(t=>{o.push(t.model)}),{nodes:s,connections:o,zoom:i.zoom,canvas:{x:i.canvasX,y:i.canvasY}}}import(t,e){const{nodeManager:n,connectionManager:i,canvas:s}=t,o=e.zoom||1;t.zoom=o,s.zoom=o,n.zoom=o,i.zoom=o,s.canvasX=e.canvas?.x||0,s.canvasY=e.canvas?.y||0,s.redrawCanvas(),n.reset?.(),i.reset?.(),e.nodes&&e.nodes.forEach(t=>{n.addNode(t)}),e.connections&&e.connections.forEach(e=>{t.addConnection(e.outNodeId,e.outPort,e.inNodeId,e.inPort)})}}class j{onConnectionAttempt({outNodeId:t,inNodeId:e}){return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:e}){}onConnectionRemoved({outNodeId:t,inNodeId:e}){}}class X extends k{constructor(t,e={}){super(t,e),this.shapeName="svg",this.shape=null,this.label=null}static get modelDefaults(){return{inputs:1,outputs:1,w:200,h:100,label:"SVG",module:"default",group:"default",name:"svg",capabilities:b,data:{}}}getNodeElement(){const t=document.createElement("div");t.className=`flow-node ${this.shapeName}-node`;const e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.classList.add("node"),this.shape=this.createShape(),this.label=this.createLabel(),this.shape.classList.add("shape"),e.appendChild(this.shape),t.appendChild(e),t.appendChild(this.label),t}init(){super.init(),this.resize()}createLabel(){const t=document.createElement("div");return t.classList.add("node-label"),t.setAttribute("contenteditable",!1),t.textContent=this.model.label,t}createShape(){if(!f.includes(this.shapeName))throw new Error(`Can not create give ${this.shapeName} svg shape`);return document.createElementNS("http://www.w3.org/2000/svg",this.shapeName)}resize(){throw new Error("Method 'resize()' must be implemented in the subclass")}}const F=[w,y,C,v];return E.register(class extends x{static get behavior(){return w}gaurd(){return"function"==typeof this.node.view.move||(console.warn("Node view does not have move method to support draggable behavior"),!1)}attach(){const t=this.node.view;this.dragHandler=new e(t.el,(t,e)=>{this.node.move(t,e)},{x:this.node.x,y:this.node.y},{x:0,y:0},t.zoomGetter),this.dragHandler.registerDragEvent()}detach(){this.dragHandler?.destroy()}}),E.register(class extends x{static active=null;constructor({node:t,options:e={}}){super({node:t,options:e}),this.selected=!1}static get behavior(){return v}attach(){const t=this.node.view;this._onPointerDown=(t=>{t.stopPropagation(),this.select()}).bind(this),t.el.addEventListener("mousedown",this._onPointerDown)}select(){this.selected||(this.constructor.active?.deselect(),this.selected=!0,this.node.select(),this.constructor.active=this)}deselect(){this.node.destroyed||this.node.deselect(),this.constructor.active=null,this.selected=!1}detach(){this._onPointerDown&&this.node?.view?.el&&this.node.view.el.removeEventListener("mousedown",this._onPointerDown)}}),E.register(class extends x{static get behavior(){return y}gaurd(){const t=this.node.view.el.querySelector(".node-label");return t?(this._el=t,!0):(console.warn("Node view does not have label element to support editable label behavior"),!1)}attach(){if(!this._el)return;this._onDblClick=(t=>{t.stopPropagation(),this._el.contentEditable="true",this._el.focus(),document.execCommand("selectAll",!1,null)}).bind(this),this._onBlur=(()=>{this._el.contentEditable="false",this.node.model.label=this._el.textContent.trim(),this.node.emit(d,{id:this.node.id,label:this.node.model.label})}).bind(this),this._onKeyDown=(t=>{"Enter"===t.key&&(t.preventDefault(),this._el.blur())}).bind(this),this._el.addEventListener("dblclick",this._onDblClick),this._el.addEventListener("blur",this._onBlur),this._el.addEventListener("keydown",this._onKeyDown)}detach(){this._el&&(this._el.removeEventListener("dblclick",this._onDblClick),this._el.removeEventListener("blur",this._onBlur),this._el.removeEventListener("keydown",this._onKeyDown),this._el=null)}}),E.register(class extends x{static get behavior(){return C}attach(){const t=this.node.view.el,n=this.node.view;this.handle=document.createElement("div"),this.handle.className="resize-handle resize-br",t.appendChild(this.handle),this.dragHandler=new e(this.handle,(t,e)=>{const n=Math.max(150,t-this.node.x),i=Math.max(50,e-this.node.y);this.node.onResize(n,i)},{x:this.node.x+this.node.w,y:this.node.y+this.node.h},{x:0,y:0},n.zoomGetter,"nwse-resize","nwse-resize"),this.dragHandler.registerDragEvent()}detach(){this.handle?.remove(),this.dragHandler?.destroy()}}),z.register(class extends X{constructor(t,e={}){super(t,e),this.shapeName="ellipse",this.ellipse=null}static get modelDefaults(){return{inputs:1,outputs:1,w:200,h:100,label:"Action",module:"diagram",group:"workflow",name:"action",capabilities:F,data:{}}}createShape(){const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return this.ellipse=t,this.ellipse}updateShape(){}resize(){const{w:t,h:e}=this.model,n=(t-1)/2,i=(e-1)/2;this.ellipse.setAttribute("cx",n),this.ellipse.setAttribute("cy",i),this.ellipse.setAttribute("rx",n),this.ellipse.setAttribute("ry",i)}}),t.DagValidator=class extends j{constructor({enabled:t=!0}={}){super(),this.enabled=t,this.adjacencyList={},this.nonCyclicCache={},this.tempCyclicCache={},this.tempStackCache={}}onConnectionAttempt({outNodeId:t,inNodeId:e}){const n="This connection will create cyclic flow.";if(!this.enabled)return{valid:!0};const i=`${t}->${e}`;if(void 0!==this.nonCyclicCache[i])return{valid:!this.nonCyclicCache[i]};if(this.tempCyclicCache[i])return{valid:!1,stack:this.tempStackCache[i],message:n};this.tempStackCache[i]=[];const s=this.tempStackCache[i],o=new Set;let a=new Set(this.adjacencyList[t]||new Set);a.add(e),o.add(t),s.push(t);for(const t of a)if(this.#r(t,o,s))return this.tempCyclicCache[i]=!0,{valid:!1,stack:s,message:n};return{valid:!0}}onConnectionAdded({outNodeId:t,inNodeId:e}){this.#h(t,e),this.#d(t,e)}onConnectionRemoved({outNodeId:t,inNodeId:e}){const n=`${t}->${e}`;this.adjacencyList[t]?.delete(e),delete this.nonCyclicCache[n],this.tempCyclicCache={}}#h(t,e){this.adjacencyList[t]||(this.adjacencyList[t]=new Set),this.adjacencyList[t].add(e)}#d(t,e){const n=`${t}->${e}`;this.nonCyclicCache[n]=!1,delete this.tempStackCache[n]}#r(t,e,n){if(n.includes(t))return n.push(t),!0;if(e.has(t))return!1;e.add(t),n.push(t);for(const i of this.adjacencyList[t]||[])if(this.#r(i,e,n))return!0;return n.pop(),!1}},t.Flow=class extends M{constructor({name:t,options:e={},validators:n=[],notification:i=null}){super({name:t}),this.options=e,this.validators=n,this.notification=i,this.serializer=new Y,this.zoom=e.zoom||1,this.originalZoom=this.zoom,this.nodes={},this.nodeIdCounter=1,this.canvasEl=null,this.svgEl=null,this.nodeManager=null,this.connectionManager=null,this.rafId=null,this.isConnecting=!1}html(){return""}init(){this.container.classList.add("floxy-flow-container"),this.canvas=new N({name:this.name+"-canvas",options:this.options}),this.canvas.renderInto(this.container),this.containerEl=this.container,this.canvasEl=this.canvas.canvasEl,this.svgEl=this.canvas.svgEl,this.nodeManager=new D({name:this.name+"-flow-node-manager",canvasContainer:this.canvasEl,zoomGetter:()=>this.zoom,options:this.options}),this.connectionManager=new H({name:this.name+"-flow-connection-manager",connectionContainer:this.svgEl,nodeManager:this.nodeManager,options:this.options}),this.canvas.on(n,({data:t})=>{this.zoom=t.zoom,this.connectionManager.zoom=t.zoom,this.nodeManager.zoom=t.zoom}),this.canvas.on(r,t=>{console.debug("Node is dropped: ",t),this.emit(r,t),this.nodeManager.dropNode(t)}),this.nodeManager.on(s,({id:t,x:e,y:n})=>{this.emit(s,{id:t,x:e,y:n}),this.connectionManager.updateConnections(t)}),this.nodeManager.on(h,({id:t,x:e,y:n,w:i,h:s})=>{this.emit(h,{id:t,x:e,y:n,w:i,h:s}),this.connectionManager.updateConnections(t)}),this.nodeManager.on(i,({id:t})=>{console.debug("Node is removed: ",t),this.emit(i,{id:t}),this.removeNode(t)}),this.nodeManager.on(c,({nodeId:t,portIndex:e,event:n})=>{console.debug("Port connect start: ",t,e,n),this.mouseDownStartConnection({dataset:{index:e}},t,n)}),this.nodeManager.on(l,({nodeId:t,portIndex:e,event:n})=>{console.debug("Port connect end: ",t,e,n),this.mouseUpCompleteConnection({dataset:{index:e}},t,n)}),this.connectionManager.on(u,t=>{console.debug("Connection is created: ",t),this.emit(u,t),this.validators.forEach(e=>e.onConnectionAdded?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))}),this.connectionManager.on(m,t=>{console.debug("Connection is clicked: ",t),this.emit(m,t),this.connectionManager.removeConnection(t)}),this.connectionManager.on(p,t=>{console.debug("Connection is removed: ",t),this.emit(p,t),this.validators.forEach(e=>e.onConnectionRemoved?.({outNodeId:t.outNodeId,inNodeId:t.inNodeId}))})}highlightCycle(t){if(t&&!(t.length<2)){console.log("FLOW: highlight cycle",t);for(let e=0;e<t.length-1;e++){const n=this.connectionManager.getAllConnections().find(n=>n.outNodeId===t[e]&&n.inNodeId===t[e+1]);n&&this.connectionManager.markPathBad(n)}}}addNode(t){return this.nodeManager.addNode(t)}mouseDownStartConnection(t,e,n){console.debug("FLOW: Start connection from port: ",t,"nodeId: ",e),n.stopPropagation(),this.isConnecting=!0,this.connectionStart={nodeId:e,index:t.dataset.index},this.connectionManager.beginTempConnection(e,t.dataset.index),this._drawConnection=n=>this.mouseMoveDrawConnection(t,e,n),this._cancelConnection=t=>this.keyDownCancelConnection(t,e),window.addEventListener("mousemove",this._drawConnection),window.addEventListener("keydown",this._cancelConnection),this.startRaf(()=>{const t=this.connectionStart.prevX==this.connectionStart.x&&this.connectionStart.prevY==this.connectionStart.y;this.connectionStart.x&&this.connectionStart.y&&!t&&(this.connectionStart.prevX=this.connectionStart.x,this.connectionStart.prevY=this.connectionStart.y,this.connectionManager.updateTempConnection(this.connectionStart.x,this.connectionStart.y))})}mouseMoveDrawConnection(t,e,n){if(this.isConnecting){this._canvasRect||(this._canvasRect=this.canvasEl.getBoundingClientRect());const t=this._canvasRect,e=(n.clientX-t.left)/this.zoom,i=(n.clientY-t.top)/this.zoom;this.connectionManager.updateTempConnection(e,i),this.connectionStart.x=e,this.connectionStart.y=i}}mouseUpCompleteConnection(t,e,n){if(this.isConnecting){const t=n.target.closest(".flow-port");if(t&&"input"===t.dataset.type){const i=parseInt(t.dataset.nodeId),s=parseInt(t.dataset.index);this.addConnection(this.connectionStart.nodeId,this.connectionStart.index,i,s,n,e)&&this.connectionManager.endTempConnection()}}}addConnection(t,e,n,i,s=null,o=null){for(const e of this.validators){const i=e.onConnectionAttempt({outNodeId:t,inNodeId:n});if(!i.valid)return this.notification?.warning(i.message),this.connectionManager.markTempPathBad(),i.stack&&this.highlightCycle(i.stack),!1}const a=this.connectionManager.addConnection(t,e,n,i);return a&&(this.validators.forEach(e=>e.onConnectionAdded?.({outNodeId:t,inNodeId:n})),s&&this.keyDownCancelConnection(s,o)),a}keyDownCancelConnection(t,e){"keydown"==t.type&&"Escape"!==t.key&&27!==t.keyCode||(this.isConnecting=!1,this.connectionManager.endTempConnection(),this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection),this._drawConnection=null))}removeNode(t){this.connectionManager.removeRelatedConnections(t)}export(){return this.serializer.export(this)}import(t){this.serializer.import(this,t)}startRaf(t){if(this.rafId)return;const e=()=>{if(!this.isConnecting)return cancelAnimationFrame(this.rafId),this.rafId=null,void(this._canvasRect=null);t(),this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}destroy(){this.isConnecting=!1,this._drawConnection&&(window.removeEventListener("mousemove",this._drawConnection),window.removeEventListener("keydown",this._cancelConnection)),cancelAnimationFrame(this.rafId)}},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
