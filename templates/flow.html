<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>floxy | Flow</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uiframe/core@0.1.0/dist/base.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@uiframe/notification@0.1.1/dist/notification.css"
    />
    <link rel="stylesheet" type="text/css" href="../dist/floxy.css" />
    <link rel="stylesheet" type="text/css" href="../src/css/themeeditor.css" />
    <link rel="stylesheet" type="text/css" href="../src/css/palette.css" />
    <style>
      body {
        height: 100vh;
        overflow: hidden;
      }

      #app-layout {
        display: flex;
        height: 100%;
      }

      #flow-wrapper {
        flex-grow: 1;
        position: relative;
        background: var(--floxy-app-bg);
      }
    </style>
  </head>

  <body>
    <!-- Palette Sidebar -->
    <div id="sidebar">
      <div class="palette-toggle" id="palette-toggle" title="Hide Palette">
        <i class="bi bi-chevron-left"></i>
      </div>
      <h5>Flow Blocks</h5>
      <p class="text-muted small">Drag blocks to canvas</p>

      <div
        class="draggable-item"
        draggable="true"
        ondragstart="drag(event)"
        data-flow-label="Start"
      >
        <i class="bi bi-play-circle me-3"></i> Start
      </div>

      <div
        class="draggable-item"
        draggable="true"
        ondragstart="drag(event)"
        data-flow-module="diagram"
        data-flow-group="workflow"
        data-flow-name="action"
      >
        <i class="bi bi-gear me-3"></i> Action
      </div>

      <div
        class="draggable-item"
        draggable="true"
        ondragstart="drag(event)"
        data-flow-label="Condition"
      >
        <i class="bi bi-question-diamond me-3"></i> Condition
      </div>

      <div
        class="draggable-item"
        draggable="true"
        ondragstart="drag(event)"
        data-flow-label="Terminate"
      >
        <i class="bi bi-stop-circle me-3"></i> End
      </div>

      <hr />
      <div class="palette-footer">
        <button class="btn btn-primary" onclick="exportData()">Export JSON</button>
        <button class="btn btn-outline-danger" onclick="clearData()">Clear</button>
      </div>
    </div>

    <div id="palette-reveal-btn" title="Show Palette">
      <i class="bi bi-list"></i>
    </div>

    <!-- Main Content Area -->
    <div id="app-layout">
      <!-- Flow Canvas Area -->
      <div id="flow-wrapper"></div>
    </div>

    <div id="theme-editor-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../dist/floxy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@uiframe/core@0.1.0/dist/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@uiframe/notification@0.1.1/dist/notification.min.js"></script>
    <script type="module">
      const validators = [new floxy.DagValidator()];

      const connectionOptions = {
        path_type: "line",
      };
      // Initialize Flow
      const flow = new floxy.Flow({
        name: "MyFlow",
        options: { zoom: 0.8, connection: connectionOptions },
        notification: uiframe.notification({ name: "floxy" }),
        validators: validators,
      });
      flow.renderInto("flow-wrapper");

      // Setup global access for drag handlers
      window.flow = flow;

      // Add some initial nodes
      const n1 = flow.addNode({
        name: "Start",
        inputs: 0,
        outputs: 1,
        x: 100,
        y: 100,
        label: "Start",
        data: {},
      });
      const n2 = flow.addNode({
        name: "Process",
        inputs: 1,
        outputs: 2,
        x: 500,
        y: 100,
        label: "Process",
        data: {},
      });
      flow.addConnection(n1, 0, n2, 0);

      window.exportData = () => {
        console.log(flow.export());
      };

      window.clearData = () => {
        flow.import({ nodes: [], connections: [] });
      };

      // Theme Editor
      const themeManager = new floxy.ThemeManager();
      const themeEditor = new floxy.ThemeEditor({ manager: themeManager });
      // themeEditor.render();
      themeEditor.renderInto("theme-editor-container");

      // Palette Toggle Logic
      const toggleBtn = document.getElementById("palette-toggle");
      const revealBtn = document.getElementById("palette-reveal-btn");

      toggleBtn.onclick = () => {
        document.body.classList.add("palette-closed");
      };

      revealBtn.onclick = () => {
        document.body.classList.remove("palette-closed");
      };
    </script>
    <script>
      function drag(ev) {
        const module = ev.target.dataset.flowModule;
        const group = ev.target.dataset.flowGroup;
        const name = ev.target.dataset.flowName;
        const label = ev.target.dataset.flowLabel;

        console.log("module", module, "group", group, "name", name, "label", label);

        ev.dataTransfer.setData("module", module);
        ev.dataTransfer.setData("group", group);
        ev.dataTransfer.setData("name", name);
        ev.dataTransfer.setData("label", label);
      }
    </script>
  </body>
</html>
